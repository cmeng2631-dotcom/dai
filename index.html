<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- ä¿®å¤ï¼šæ·»åŠ  maximum-scale=1.0 å’Œ user-scalable=no æ¥ç¦æ­¢ç”¨æˆ·ç¼©æ”¾ï¼Œé˜²æ­¢è¾“å…¥æ¡†èšç„¦æ—¶é¡µé¢æ”¾å¤§ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¿§éƒé£æ ¼å…¨å±æ‰‹æœºä¸»å±å¹•</title>

    <!-- iOS Web App å…¨å±æ”¯æŒ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/è¿™é‡Œæ”¾ä½ æƒ³åœ¨ä¸»é¡µé¢æ˜¾ç¤ºçš„å›¾æ ‡é“¾æ¥.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- ç”¨äºåŠ¨æ€åŠ è½½è‡ªå®šä¹‰å­—ä½“çš„æ ·å¼å— -->
    <style id="custom-font-style-block"></style>
    
    <style>
        /* --- CSS å˜é‡å®šä¹‰ --- */
        :root {
            --theme-base-color: #3A3F4A;
            --theme-secondary-color: #5A6070;
            --theme-base-color-rgb: 58, 63, 74;
            --global-opacity: 0.7;
            --battery-fill-color: #ADD8E6;
            --battery-border-color: #FFFFFF;
            --global-font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            --global-font-color: #D3D7E0;
            --global-font-weight: 300;
            /* å¾®ä¿¡ä¸»é¢˜è‰² */
            --wechat-theme-green: #07C160;
        }

        /* --- åŸºç¡€å’Œå¸ƒå±€æ ·å¼ --- */
        body {
            margin: 0; padding: 0; background: #2C2F3A; display: flex;
            justify-content: center; align-items: center; height: 100vh;
            width: 100vw; font-family: var(--global-font-family); color: var(--global-font-color);
            font-weight: var(--global-font-weight); box-sizing: border-box; -webkit-font-smoothing: antialiased;
        }

        /* --- å±å¹•å®¹å™¨ --- */
        .phone-screen, .settings-screen, .icon-settings-screen, .theme-settings-screen,
        .font-settings-screen, .character-settings-screen, .dialogue-screen, .world-book-screen,
        .friend-settings-screen, .api-settings-screen, .wechat-container-screen, .wechat-new-moment-screen,
        .wechat-select-friends-screen, .wechat-wallet-screen, .wechat-visibility-settings-screen,
        .wechat-group-settings-screen /* æ–°å¢ */
         {
            width: 100%; max-width: 414px; height: 100vh; background: #1A1C22;
            overflow: hidden; position: relative; background-size: cover; background-position: center;
            background-repeat: no-repeat; display: flex; flex-direction: column;
        }

        /* --- ä¸»å±å¹•ç»„ä»¶ --- */
        .dynamic-island {
            width: 120px; height: 30px; background: #000; border-radius: 15px; position: absolute;
            top: 10px; left: 50%; transform: translateX(-50%); transition: transform 0.2s ease-out;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 10px; box-sizing: border-box; font-size: 14px; cursor: pointer;
        }
        .dynamic-island.clicked { transform: translateX(-50%) scale(1.1); }
        .status-bar { display: flex; justify-content: space-between; padding: 10px 20px; font-size: 14px; }
        .battery { display: flex; align-items: center; position: relative; width: 24px; height: 11px;
            border: 1px solid var(--battery-border-color); border-radius: 3px; background: transparent;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.3); }
        .battery::after { content: ''; position: absolute; right: -3px; top: 3px; width: 2px; height: 5px;
            background: var(--battery-border-color); border-radius: 1px; }
        .battery-fill { height: 9px; border-radius: 2px; margin-left: 1px; width: 85%;
            background-color: var(--battery-fill-color); }
        .user-info { text-align: center; margin-top: 30px; padding: 0 20px; }
        .avatar-container { position: relative; margin: 0 auto; width: 80%; max-width: 300px;
            height: 120px; background-color: rgba(var(--theme-base-color-rgb), var(--global-opacity));
            border-radius: 20px; display: flex; justify-content: center; align-items: center; cursor: pointer;
            background-size: cover; background-position: center; background-repeat: no-repeat; }
        .avatar { width: 60px; height: 60px; border-radius: 50%; position: absolute; top: 80px; cursor: pointer;
            background-size: cover; background-position: center; background-repeat: no-repeat; border: 2px solid #FFFFFF; box-sizing: border-box; }
        .user-name { margin-top: 30px; font-size: 18px; font-weight: var(--global-font-weight); }
        .user-bio { font-size: 14px; color: #8A8FA0; margin: 5px 0; }
        .user-location { font-size: 12px; color: #8A8FA0; display: flex; justify-content: center; align-items: center; }
        .user-location::before { content: 'â„ï¸'; margin-right: 5px; }
        .widgets-apps { display: flex; justify-content: center; gap: 20px; padding: 20px; margin-top: 20px;
            align-items: flex-start; flex-grow: 1; }
        .widget { width: 150px; height: 150px; background-color: rgba(var(--theme-base-color-rgb), var(--global-opacity));
            border-radius: 15px; display: flex; justify-content: center; align-items: center;
            font-size: 14px; cursor: pointer; background-size: cover; background-position: center; background-repeat: no-repeat; }
        .apps { display: grid; grid-template-columns: repeat(2, 1fr); column-gap: 10px; row-gap: 30px; }
        .app-container { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .app { width: 60px; height: 60px; background-color: rgba(var(--theme-base-color-rgb), var(--global-opacity));
            border-radius: 15px; display: flex; justify-content: center; align-items: center;
            font-size: 24px; transition: transform 0.2s; background-size: cover; background-position: center; cursor: pointer; }
        .app:hover { transform: scale(1.1); }
        .app-label { font-size: 12px; }
        .nav-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%;
            max-width: 380px; height: 60px; background: rgba(var(--theme-base-color-rgb), var(--global-opacity));
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 20px;
            display: flex; justify-content: space-around; align-items: center; margin-bottom: 10px; }
        .nav-app { background-color: rgba(var(--theme-base-color-rgb), var(--global-opacity)); border: none; padding: 0;
            font-family: inherit; color: inherit; width: 48px; height: 48px; border-radius: 12px; display: flex;
            justify-content: center; align-items: center; font-size: 14px; transition: transform 0.2s; cursor: pointer; }
        .nav-app:hover { transform: scale(1.1); }

        /* --- è®¾ç½®ç•Œé¢é€šç”¨æ ·å¼ --- */
        /* æ‰€æœ‰è®¾ç½®é¡µé¢çš„å¯¼èˆªæ æ¢å¤é€æ˜ */
        .settings-screen .settings-header, 
        .icon-settings-screen .settings-header, 
        .theme-settings-screen .settings-header,
        .font-settings-screen .settings-header, 
        .character-settings-screen .settings-header, 
        .world-book-screen .settings-header, 
        .friend-settings-screen .settings-header, /* å¥½å‹è®¾ç½®é¡µé¢å¯¼èˆªæ æ¢å¤é€æ˜ */
        .api-settings-screen .settings-header {
            background: transparent; /* æ¢å¤ä¸ºé€æ˜ */
            border-bottom: none; /* ç§»é™¤è¾¹æ¡† */
            color: var(--global-font-color); /* æ¢å¤å­—ä½“é¢œè‰² */
        }
        /* æ‰€æœ‰è®¾ç½®é¡µé¢çš„æ ‡é¢˜å’ŒæŒ‰é’®é¢œè‰²æ¢å¤ */
        .settings-screen .settings-header .title,
        .icon-settings-screen .settings-header .title,
        .theme-settings-screen .settings-header .title,
        .font-settings-screen .settings-header .title,
        .character-settings-screen .settings-header .title,
        .world-book-screen .settings-header .title,
        .friend-settings-screen .settings-header .title,
        .api-settings-screen .settings-header .title,
        .settings-screen .settings-header button, 
        .icon-settings-screen .settings-header button, 
        .theme-settings-screen .settings-header button,
        .font-settings-screen .settings-header button, 
        .character-settings-screen .settings-header button, 
        .world-book-screen .settings-header button, 
        .friend-settings-screen .settings-header button, 
        .api-settings-screen .settings-header button {
            color: var(--global-font-color); /* æ¢å¤æŒ‰é’®å­—ä½“é¢œè‰² */
        }

        .settings-screen, .icon-settings-screen, .theme-settings-screen, .font-settings-screen,
        .world-book-screen, .friend-settings-screen, .api-settings-screen, .wechat-container-screen,
        .wechat-new-moment-screen, .wechat-select-friends-screen, .wechat-wallet-screen,
        .wechat-visibility-settings-screen, .wechat-group-settings-screen {
            display: none; z-index: 10; padding: 10px 20px; box-sizing: border-box; }

        /* ä¿®æ”¹ä¸»é¢˜ç¾åŒ–å’Œå­—ä½“è®¾ç½®å±å¹•çš„ main åŒºåŸŸï¼Œä½¿å…¶å¯æ»šåŠ¨ */
        .theme-settings-screen main,
        .font-settings-screen main {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 20px; /* ç¡®ä¿åº•éƒ¨æœ‰è¶³å¤Ÿç©ºé—´ */
        }

        .settings-header { height: 44px; display: flex; align-items: center; justify-content: space-between;
            position: relative; flex-shrink: 0; } 
        .settings-header .title { font-size: 18px; font-weight: 500; position: absolute; left: 50%; transform: translateX(-50%); }
        .settings-header button { background: none; border: none; font-size: 16px; cursor: pointer; padding: 0; }
        .settings-list { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        .settings-item { background-color: rgba(var(--theme-base-color-rgb), var(--global-opacity)); padding: 12px 15px;
            border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 16px; }
        .settings-item:hover { filter: brightness(1.2); }
        .icon-edit-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 40px; justify-items: center; }
        .icon-editable { cursor: pointer; }

        /* --- ä¸»é¢˜/å­—ä½“/APIè®¾ç½®è¡¨å•æ ·å¼ --- */
        .theme-controls { padding: 20px; margin-top: 15px; background-color: rgba(var(--theme-base-color-rgb), var(--global-opacity));
            border-radius: 10px; display: flex; flex-direction: column; gap: 20px; }
        .theme-controls h4 { margin: 0 0 10px 0; font-weight: 500; border-bottom: 1px solid #8A8FA0; padding-bottom: 10px; }
        .theme-control-item { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .theme-control-item label { font-size: 16px; width: 100%; margin-bottom: 8px; }
        input[type="color"] { width: 40px; height: 40px; border: none; padding: 0; border-radius: 50%;
            cursor: pointer; background-color: transparent; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid #8A8FA0; border-radius: 50%; }
        input[type="range"] { flex-grow: 1; margin-left: 20px; }
        .action-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        .action-buttons button, .action-btn { padding: 8px 16px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; }
        .save-btn { background-color: #007AFF; color: white; }
        .reset-btn { background-color: #555; color: white; }
        .action-btn { background-color: #007AFF; color: white; flex-grow: 1; }
        .font-input, .api-input, .model-select { width: 100%; padding: 10px; box-sizing: border-box; background-color: #5A6070;
            border: 1px solid #8A8FA0; border-radius: 5px; color: var(--global-font-color); margin-top: 5px; }
        .model-select { -webkit-appearance: none; appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23D3D7E0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat; background-position: right 10px top 50%; background-size: 10px auto; padding-right: 30px; }

        /* ä¿®å¤ï¼šé˜²æ­¢ç§»åŠ¨ç«¯è¾“å…¥æ—¶é¡µé¢æ”¾å¤§ */
        #message-input, .new-moment-content textarea, .modal input, .form-group input, .form-group textarea, .api-input, .font-input {
            font-size: 16px;
        }

        /* --- èŠå¤©ç›¸å…³ç•Œé¢æ ·å¼ --- */
        .character-item-wrapper {
            position: relative;
            overflow: hidden; /* Hide swipe actions initially */
            display: flex; /* Allow content and actions to sit side-by-side */
            width: 100%; /* Take full width */
            background-color: #FFFFFF; /* Ensure solid background for swipe */
            border-bottom: 1px solid #E5E5E5;
        }
        .character-item-wrapper:last-child {
            border-bottom: none;
        }
        .character-item { display: flex; align-items: center; gap: 15px; padding: 10px 15px;
            background-color: #FFFFFF; /* Should be explicitly white to prevent transparency issues */
            color: #000;
            flex-grow: 1; /* Take all available space in wrapper */
            position: relative;
            z-index: 10;
            transition: transform 0.3s ease-out; /* Smooth slide effect */
            cursor: pointer;
            border-radius: 0 !important; /* Override default if any */
        }
        /* ä¿®æ”¹ç½®é¡¶å¥½å‹çš„èƒŒæ™¯é¢œè‰²ä¸ºæµ…ç°è‰² */
        .character-item.pinned {
            background-color: #EAEAEA; /* æµ…ç°è‰² */
        }
        /* ç§»é™¤ç½®é¡¶è¡¨æƒ…å¼¹çª— */
        .character-item .pin-indicator {
            display: none; /* ç›´æ¥éšè—è¡¨æƒ… */
        }

        .swipe-actions {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            transform: translateX(100%); /* Initially off-screen */
            transition: transform 0.3s ease-out;
            z-index: 9; /* Below character-item */
            background-color: #FFC107; /* Default for pin, will be overridden */
        }
        .character-item-wrapper.swiped .character-item {
            transform: translateX(-120px); /* Adjust based on actions width */
        }
        .character-item-wrapper.swiped .swipe-actions {
            transform: translateX(0);
        }
        .swipe-actions button {
            height: 100%;
            width: 60px; /* Width of each action button */
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .action-pin { background-color: #FFC107; } /* Yellow for Pin */
        .action-delete { background-color: #EA5455; } /* Red for Delete */


        .character-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: #5A6070;
            background-size: cover; background-position: center; background-repeat: no-repeat; flex-shrink: 0; }
        .character-name { font-size: 16px; }
        /* è§’è‰²è®¾å®šèƒŒæ™¯ç¡®ä¿ä¸é€æ˜ */
        .character-settings-screen { 
            display: none; z-index: 10; padding: 0 5px; box-sizing: border-box; 
            background: #F7F7F7 !important; /* ç¡®ä¿ä¸ºå®è‰² */ 
            color: #333; 
        }
        .character-settings-screen > main { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .character-settings-form { display: flex; flex-direction: column; align-items: center; gap: 20px; padding: 20px;
            background: #FFFFFF; border-radius: 15px; }
        .avatar-preview { width: 100px; height: 100px; border-radius: 50%; background-color: #E5E5EA;
            background-size: cover; background-position: center; background-repeat: no-repeat; cursor: pointer;
            border: 2px dashed #8A8FA0; display: flex; justify-content: center; align-items: center; font-size: 14px;
            color: #8A8FA0; box-sizing: border-box; text-align: center; overflow: hidden; flex-shrink: 0; }
        .avatar-preview::before { content: 'ç‚¹å‡»ä¸Šä¼ å¤´åƒ'; display: block; padding: 10px; }
        .avatar-preview.has-image::before { content: none; }
        .form-group { width: 100%; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 14px; color: #8A8FA0; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; box-sizing: border-box;
            background-color: #F7F7F7; border: 1px solid #E5E5EA; border-radius: 8px; color: #333; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-actions { display: flex; gap: 15px; width: 100%; justify-content: center; margin-top: 20px; }
        .form-actions button { flex-grow: 1; padding: 12px; border-radius: 10px; border: none; font-size: 16px; cursor: pointer; }
        #save-char-btn { background-color: #007AFF; color: white; }
        #cancel-char-btn { background-color: #555; color: white; }
        /* å¯¹è¯ç•Œé¢èƒŒæ™¯å®è‰² */
        .dialogue-screen { 
            display: flex; flex-direction: column; padding: 10px 0 0 0; 
            background: #F7F7F7 !important; /* ç¡®ä¿å¯¹è¯ç•Œé¢èƒŒæ™¯ä¸ºå®è‰² */ 
        }
        /* å¯¹è¯é¡µé¢çš„å¯¼èˆªæ å®è‰² */
        .dialogue-screen .settings-header {
            background-color: #F7F7F7 !important; /* ç¡®ä¿ä¸ºå®è‰² */
            border-bottom: 1px solid #DCDCDC !important; /* ç¡®ä¿æœ‰è¾¹æ¡† */
        }
        .dialogue-screen .settings-header .title,
        .dialogue-screen .settings-header button {
            color: #000 !important; /* ç¡®ä¿æ ‡é¢˜å’ŒæŒ‰é’®é¢œè‰² */
        }
        #dialogue-settings-btn { font-size: 20px; font-weight: bold; line-height: 1; padding: 0 5px; }
        #dialogue-content { flex-grow: 1; min-height: 0; overflow-y: auto; padding: 10px; display: flex;
            flex-direction: column; gap: 15px; }
        .message-row { display: flex; gap: 10px; align-items: flex-end; }
        .message-row.my-message { justify-content: flex-end; }
        .message-row.their-message { justify-content: flex-start; }
        /* ç³»ç»Ÿæ¶ˆæ¯æ ·å¼ */
        .message-row.system-message {
            justify-content: center; /* å±…ä¸­æ˜¾ç¤º */
            margin: 5px 0;
        }
        .system-message .chat-system-text {
            font-size: 12px; /* å°å­—ä½“ */
            color: #8A8FA0; /* æµ…ç°è‰² */
            padding: 4px 8px;
            border-radius: 5px;
            background-color: rgba(0, 0, 0, 0.05); /* ç•¥å¾®èƒŒæ™¯è‰² */
        }

        .chat-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #ccc;
            background-size: cover; background-position: center; flex-shrink: 0; }
        .chat-bubble { max-width: 65%; padding: 10px 15px; border-radius: 18px; line-height: 1.4; word-wrap: break-word; }
        .my-bubble { background-color: #007AFF; color: white; border-bottom-right-radius: 4px; border: 1px solid rgba(0, 0, 0, 0.1); } /* æˆ‘çš„æ°”æ³¡æè¾¹ */
        .their-bubble { background-color: #FFFFFF; color: #333; border-bottom-left-radius: 4px; border: 1px solid #E5E5EA; }
        .wechat-voice-bubble { background-color: #007AFF; color: white; border-bottom-right-radius: 4px; display: flex;
            align-items: center; gap: 8px; padding: 8px 12px; min-width: 70px; justify-content: flex-end; cursor: pointer; border: 1px solid rgba(0, 0, 0, 0.1); } /* æˆ‘çš„è¯­éŸ³æ°”æ³¡æè¾¹ */
        .voice-duration { font-size: 14px; color: #FFFFFF; margin-right: 5px; order: -1; }
        .wechat-voice-icon { width: 16px; height: 16px; position: relative; transform: rotate(90deg); }
        .wechat-voice-icon span { position: absolute; bottom: 0; left: 50%; background-color: #FFFFFF;
            border-radius: 2px; transform-origin: bottom; width: 2px; }
        .wechat-voice-icon .bar1 { height: 30%; transform: translateX(-4px); }
        .wechat-voice-icon .bar2 { height: 60%; transform: translateX(0px); }
        .wechat-voice-icon .bar3 { height: 100%; transform: translateX(4px); }
        /* å¯¹è¯åº•éƒ¨å¯¼èˆªæ å¸ƒå±€ä¿®æ”¹ */
        .dialogue-footer { 
            position: relative; flex-shrink: 0; width: 100%; min-height: 50px; /* å‡å°é«˜åº¦ */
            display: flex; align-items: center; padding: 5px 15px; /* å‡å°padding */
            box-sizing: border-box; background-color: #F7F7F7; border-top: 1px solid #E5E5EA; 
            gap: 5px; /* å‡å°é—´è· */
        }
        #message-input { 
            flex-grow: 1; height: 32px; /* å‡å°é«˜åº¦ */ padding: 0 12px; /* å‡å°padding */
            border: none; border-radius: 16px; /* æ›´åŠ åœ†æ¶¦ */ background-color: #FFFFFF; color: #333; outline: none; 
            font-size: 14px; /* å‡å°å­—å·ä»¥é€‚åº”æ›´å°çš„é«˜åº¦ */
        }
        .footer-icon-btn { 
            background: none; border: none; font-size: 18px; /* ç¨å¾®å‡å°å­—å·ä»¥é€‚åº”æ›´å°çš„é«˜åº¦ */ color: #5A6070; cursor: pointer;
            padding: 0; display: flex; align-items: center; justify-content: center; 
            width: 32px; height: 32px; /* å‡å°å°ºå¯¸ä»¥é€‚åº”æ›´å°çš„é«˜åº¦ */ border-radius: 50%; transition: transform 0.2s, background-color 0.2s; 
        }
        /* æŒ‰é’®æŒ‰å‹åœ†å½¢æ•ˆæœ */
        .footer-icon-btn:active {
            transform: scale(0.9); /* ç¼©å° */
            background-color: rgba(0, 0, 0, 0.1); /* æµ…è‰²èƒŒæ™¯ */
            box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.1); /* æ¨¡æ‹Ÿåœ†å½¢æè¾¹ */
            transition: transform 0.1s ease-out, background-color 0.1s ease-out, box-shadow 0.1s ease-out;
        }

        #send-message-btn { 
            padding: 6px 12px; /* è°ƒæ•´paddingä»¥é€‚åº”æ–°é«˜åº¦ */ border: none; border-radius: 16px; /* æ›´åŠ åœ†æ¶¦ */ background-color: #07C160;
            color: white; cursor: pointer; font-size: 14px; /* å‡å°å­—å·ä»¥é€‚åº”æ›´å°çš„é«˜åº¦ */ height: 32px; /* å‡å°é«˜åº¦ */ flex-shrink: 0; 
        }
        #functions-menu { position: absolute; bottom: 100%; left: 0; right: 0; background-color: #F0F0F0;
            border-top: 1px solid #E5E5EA; display: none; flex-direction: column; padding: 10px 0; }
        .function-menu-item { padding: 12px 20px; font-size: 16px; color: #333; cursor: pointer; }
        .function-menu-item:hover { background-color: #E5E5EA; }

        /* --- ä¸–ç•Œä¹¦ & å¥½å‹è®¾ç½® --- */
        .world-book-main { flex-grow: 1; padding: 10px 20px; box-sizing: border-box; overflow-y: auto; }
        .world-book-tabs { display: flex; justify-content: space-around; background-color: rgba(var(--theme-base-color-rgb), 0.5);
            border-radius: 10px; padding: 5px; margin-bottom: 20px; gap: 5px; }
        .world-book-tabs .tab-button { flex: 1; padding: 10px; border: none; border-radius: 8px; background-color: transparent;
            color: var(--global-font-color); font-size: 16px; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .world-book-tabs .tab-button.active { background-color: #007AFF; color: white; font-weight: 500; }
        .world-book-tab-content { display: none; }
        .world-book-tab-content.active { display: block; }
        .tab-content-title { font-size: 16px; font-weight: 500; color: #D3D7E0; margin: 15px 0 10px 0; padding-bottom: 5px;
            border-bottom: 1px solid rgba(var(--theme-base-color-rgb), 0.5); }
        .world-book-list { display: flex; flex-direction: column; gap: 10px; }
        .world-book-item { background-color: rgba(var(--theme-base-color-rgb), var(--global-opacity)); padding: 12px 15px;
            border-radius: 10px; display: flex; justify-content: space-between; align-items: center;
            font-size: 16px; color: var(--global-font-color); }
        .world-book-item > div { display: flex; gap: 8px; }
        .world-book-item button { padding: 6px 12px; border: none; border-radius: 6px; font-size: 13px;
            cursor: pointer; transition: background-color 0.2s; }
        .world-book-item .apply-btn { background-color: #007AFF; color: white; }
        .world-book-item .edit-btn { background-color: #555; color: white; }
        .world-book-item .delete-btn { background-color: #EA5455; color: white; }
        .friend-settings-screen { background-color: #F7F7F7; color: #333; }
        
        /* æ–°å¢æ°”æ³¡è‡ªå®šä¹‰æ ·å¼ */
        .bubble-customization-section {
            width: 100%; background: #F0F0F0; border-radius: 10px; padding: 15px;
            display: flex; flex-direction: column; gap: 15px;
            margin-bottom: 20px; /* Add margin for spacing */
        }
        .bubble-color-setting {
            display: flex; justify-content: space-between; align-items: center;
        }
        .bubble-color-setting label {
            font-size: 15px; color: #333; margin-bottom: 0; /* Override form-group label margin */
        }
        .bubble-preview-container {
            border: 1px dashed #DCDCDC; border-radius: 8px; padding: 10px; background-color: #fff;
        }
        .preview-my-bubble {
            background-color: #007AFF;
            color: white;
            border-bottom-right-radius: 4px;
            border: 1px solid rgba(0, 0, 0, 0.1); /* æˆ‘çš„æ°”æ³¡æè¾¹ */
        }
        .preview-their-bubble {
            background-color: #FFFFFF;
            color: #333;
            border: 1px solid #E5E5EA;
            border-bottom-left-radius: 4px;
        }
        /* Make sure preview avatars are simple */
        .bubble-preview-container .chat-avatar {
            background-color: #ccc;
        }
        .bubble-preview-container .my-message .chat-avatar {
             background-color: #007AFF; /* My default avatar color in preview */
        }
        .bubble-preview-container .their-message .chat-avatar {
             background-color: #ccc; /* Their default avatar color in preview */
        }


        /* --- å¾®ä¿¡ç•Œé¢æ ·å¼ --- */
        .wechat-container-screen { background: #EDEDED; color: #000; font-family: var(--global-font-family);
            font-weight: 400; padding: 0; }
        .wechat-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px;
            height: 44px; background-color: #F7F7F7; border-bottom: 1px solid #DCDCDC; flex-shrink: 0;
            box-sizing: border-box; color: #000; }
        .wechat-header button { background: none; border: none; font-size: 16px; cursor: pointer; color: #000; }
        .wechat-header #wechat-header-title { font-size: 18px; font-weight: 500; }
        .wechat-header #wechat-header-actions { display: flex; align-items: center; min-width: 50px; justify-content: flex-end; }
        .wechat-header #wechat-header-actions button { font-size: 24px; padding: 5px; }
        #wechat-page-container { flex-grow: 1; overflow-y: auto; position: relative; }
        .wechat-page { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; overflow-y: auto; }
        .wechat-page.active { display: block; }
        #wechat-nav-bar { display: flex; height: 50px; background-color: #F7F7F7; border-top: 1px solid #DCDCDC; flex-shrink: 0; }
        .wechat-nav-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 10px; color: #777; cursor: pointer; }
        .wechat-nav-item span { font-size: 22px; }
        .wechat-nav-item.active { color: var(--wechat-theme-green); }

        /* èŠå¤©å’Œé€šè®¯å½•åˆ—è¡¨æ ·å¼ */
        #wechat-chat-list-page #character-list, #wechat-contacts-page #wechat-contacts-list { margin-top: 0; padding: 0; } /* Remove gap from here, handled by wrapper */
        #wechat-chat-list-page .character-item, #wechat-contacts-page .character-item {
             /* Styles moved to .character-item within .character-item-wrapper */
        }
        #wechat-chat-list-page, #wechat-contacts-page { background-color: #FFFFFF; }
        #wechat-chat-list-page .character-avatar, #wechat-contacts-page .character-avatar { border-radius: 8px; }
        
        /* æœ‹å‹åœˆæ ·å¼ */
        #wechat-moments-page { background-color: #FFFFFF; }
        .moments-header { position: relative; margin-bottom: 40px; }
        .moments-bg { width: 100%; height: 250px; background-color: #8A8FA0; background-size: cover; background-position: center; }
        .moments-user-info { position: absolute; bottom: -20px; right: 15px; display: flex; align-items: center; gap: 10px; }
        .moments-user-name { font-size: 16px; font-weight: 500; color: #FFF; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .moments-avatar { width: 70px; height: 70px; border-radius: 8px; border: 2px solid #FFF; background-color: #ccc;
            background-size: cover; background-position: center; }
        #moments-posts-container { padding-bottom: 20px; } /* æ–°å¢ */
        .moment-post { display: flex; gap: 10px; padding: 15px; border-bottom: 1px solid #F0F0F0; } /* æ–°å¢ */
        .moment-post-avatar { width: 40px; height: 40px; border-radius: 6px; flex-shrink: 0; } /* æ–°å¢ */
        .moment-post-main { display: flex; flex-direction: column; gap: 8px; flex-grow: 1; } /* æ–°å¢ */
        .moment-post-author { font-size: 16px; font-weight: 500; color: #576B95; } /* æ–°å¢ */
        .moment-post-content { font-size: 15px; line-height: 1.5; word-wrap: break-word; } /* æ–°å¢ */
        .moment-post-location { font-size: 12px; color: #888; } /* æ–°å¢ */
        .moment-post-footer { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #888; } /* æ–°å¢ */
        .moment-delete-btn { color: #576B95; cursor: pointer; } /* æ–°å¢ */
        .moment-comments-section { background-color: #F7F7F7; border-radius: 4px; padding: 8px; margin-top: 10px; font-size: 14px; } /* æ–°å¢ */
        .moment-comment { margin-bottom: 4px; } /* æ–°å¢ */
        .moment-comment:last-child { margin-bottom: 0; } /* æ–°å¢ */
        .comment-author { color: #576B95; font-weight: 500; } /* æ–°å¢ */

        /* "æˆ‘" é¡µé¢æ ·å¼ */
        #wechat-me-page { background-color: #F7F7F7; }
        .me-profile-header { display: flex; align-items: center; gap: 20px; background-color: #FFFFFF;
            padding: 40px 20px 20px 20px; margin-bottom: 10px; }
        .me-avatar { width: 60px; height: 60px; border-radius: 8px; background-color: #ccc;
            background-size: cover; background-position: center; flex-shrink: 0; }
        .me-profile-info { display: flex; flex-direction: column; gap: 5px; }
        .me-name { font-size: 20px; font-weight: 500; }
        .me-id { font-size: 14px; color: #888; }
        .me-options-list { background-color: #FFFFFF; }
        .me-option-item { display: flex; justify-content: space-between; align-items: center; gap: 15px;
            padding: 12px 20px; font-size: 16px; border-bottom: 1px solid #F0F0F0; cursor: pointer; }
        .me-option-item:last-child { border-bottom: none; }
        .me-option-item .option-label { display: flex; align-items: center; gap: 15px; }
        .me-option-item .option-label span { font-size: 22px; }
        .me-option-item .option-value { color: #888; font-size: 14px; }

        /* å„ç§è®¾ç½®é¡µ & é’±åŒ…é¡µ */
        .wechat-wallet-screen, .wechat-new-moment-screen, .wechat-select-friends-screen,
        .wechat-visibility-settings-screen, .wechat-group-settings-screen {
            background-color: #F7F7F7; color: #000; padding: 0; }
        .simple-header { display: flex; align-items: center; padding: 10px 15px; height: 44px;
            background-color: #F7F7F7; border-bottom: 1px solid #DCDCDC; flex-shrink: 0;
            box-sizing: border-box; color: #000; position: relative; }
        .simple-header button { background:none; border:none; font-size: 16px; color: #000; cursor: pointer; }
        .simple-header .title { position: absolute; left: 50%; transform: translateX(-50%); font-size: 18px; font-weight: 500; }
        .wallet-balance-card { background-color: var(--wechat-theme-green); color: #FFF; padding: 20px;
            margin: 20px; border-radius: 10px; text-align: center; }
        .new-moment-content { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .new-moment-content textarea { width: 100%; height: 150px; border: none; outline: none; background: none;
            resize: none; margin-bottom: 10px; }
        .new-moment-content .me-options-list { margin-top: 10px; }
        .select-friends-content { flex-grow: 1; overflow-y: auto; background-color: #FFF; }
        .friend-select-item { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid #E5E5E5; }
        .friend-select-item input[type="checkbox"] { width: 20px; height: 20px; margin-right: 15px; }
        .visibility-options-list .me-option-item { justify-content: flex-start; }
        .visibility-options-list input[type="radio"] { width: 20px; height: 20px; margin-right: 15px; }

        /* --- å¼¹çª—æ ·å¼ --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6);
            display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: #FFFFFF; color: #333; padding: 25px; border-radius: 25px; width: 80%;
            max-width: 320px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); text-align: left; }
        .modal h3 { margin-top: 0; margin-bottom: 15px; font-weight: 600; }
        .modal input[type="text"], .modal textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px;
            box-sizing: border-box; margin-bottom: 15px; background-color: #F7F7F7; color: #333; }
        .modal textarea { resize: vertical; min-height: 100px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-actions button { padding: 8px 16px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; }
        .modal-method-switcher {
            display: flex; margin-bottom: 15px; border: 1px solid #E5E5EA;
            border-radius: 8px; overflow: hidden;
        }
        .modal-method-switcher button {
            flex: 1; padding: 8px; border: none; background-color: #FFFFFF;
            color: #333; cursor: pointer; transition: background-color 0.2s;
        }
        .modal-method-switcher button:first-child { border-right: 1px solid #E5E5EA; }
        .modal-method-switcher button.active { background-color: #007AFF; color: white; }
        
        /* é€šç”¨åé¦ˆå¼¹çª— (ç»¿è‰²æˆåŠŸæç¤º) */
        .feedback-modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            display: none; /* Initial state */
            justify-content: center; 
            align-items: center; 
            z-index: 99999; /* ç¡®ä¿åœ¨æœ€é¡¶å±‚ï¼Œæ¯”æ‰€æœ‰å…¶ä»– z-index éƒ½é«˜ */
        }
        .feedback-modal { 
            background: #28C76F; /* ç»¿è‰²èƒŒæ™¯ */ 
            color: #FFFFFF; 
            padding: 20px; 
            border-radius: 15px;
            width: auto; 
            min-width: 150px; 
            max-width: 80%; 
            text-align: center; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); 
            opacity: 0; 
            transform: scale(0.9); 
            transition: opacity 0.2s ease-out, transform 0.2s ease-out; /* Use ease-out for smoother hide */
        }
        .feedback-modal-overlay.visible { 
            display: flex; 
        }
        .feedback-modal-overlay.visible .feedback-modal { 
            opacity: 1; 
            transform: scale(1); 
        }
        .feedback-modal.error { background-color: #EA5455; } /* çº¢è‰²å¤±è´¥æç¤º */
        .feedback-modal p { margin: 0; font-size: 16px; font-weight: 500; }
    </style>
</head>
<body>

    <!-- ä¸»å±å¹• -->
    <section class="phone-screen">
        <header class="status-bar"><div class="time"></div><div class="battery" id="battery"><div class="battery-fill" id="batteryFill"></div></div></header>
        <div class="dynamic-island"><span>ğŸ§</span><span id="dynamic-island-text">owo</span></div>
        <main>
            <div class="user-info">
                <div class="avatar-container image-editable"><div class="avatar image-editable"></div></div>
                <div class="user-name editable">è‡ªå®šä¹‰åå­—</div><div class="user-bio editable">è‡ªå®šä¹‰ä¸ªæ€§ç­¾å</div><div class="user-location editable">è‡ªå®šä¹‰ä½ç½®</div>
            </div>
            <div class="widgets-apps">
                <div class="widget image-editable">å°ç»„ä»¶</div>
                <div class="apps">
                    <div class="app-container" id="wechat-app-btn"><div class="app" id="home-app-icon-1">ğŸ“±</div><span class="app-label">å¾®ä¿¡</span></div>
                    <div class="app-container" id="world-book-app-btn"><div class="app" id="home-app-icon-2">ğŸ“–</div><span class="app-label">ä¸–ç•Œä¹¦</span></div>
                    <div class="app-container"><div class="app" id="home-app-icon-3">ğŸ—ºï¸</div><span class="app-label">åœ°å›¾</span></div>
                    <div class="app-container" id="settings-app-btn"><div class="app" id="home-app-icon-4">âš™ï¸</div><span class="app-label">è®¾ç½®</span></div>
                </div>
            </div>
        </main>
        <nav class="nav-bar">
            <button type="button" class="nav-app" id="api-settings-btn">API</button><button type="button" class="nav-app">å¯¼èˆª2</button>
            <button type="button" class="nav-app">å¯¼èˆª3</button><button type="button" class="nav-app">å¯¼èˆª4</button>
        </nav>
    </section>

    <!-- API è®¾ç½®ç•Œé¢ -->
    <section class="api-settings-screen">
        <header class="settings-header"><button id="back-to-home-from-api-btn">&lt; è¿”å›</button><span class="title">API è®¾ç½®</span></header>
        <main>
            <div class="theme-controls"><h4>è¿æ¥è®¾ç½®</h4><div class="theme-control-item"><label for="api-url-input">API åœ°å€</label><input type="text" id="api-url-input" class="api-input" placeholder="ä¾‹å¦‚: https://api.openai.com"></div><div class="theme-control-item"><label for="api-key-input">API å¯†é’¥</label><input type="password" id="api-key-input" class="api-input" placeholder="è¯·è¾“å…¥ API å¯†é’¥"></div></div>
            <div class="theme-controls"><h4>æ¨¡å‹é€‰æ‹©</h4><div class="theme-control-item"><button id="fetch-models-btn" class="action-btn">è·å–æ¨¡å‹åˆ—è¡¨</button></div><div class="theme-control-item"><label for="model-select">é€‰æ‹©æ¨¡å‹</label><select id="model-select" class="model-select"><option value="">è¯·å…ˆè·å–æ¨¡å‹åˆ—è¡¨</option></select></div><div class="action-buttons"><button id="api-save-btn" class="save-btn">ä¿å­˜è®¾ç½®</button></div></div>
        </main>
    </section>

    <!-- è®¾ç½®ç•Œé¢ -->
    <section class="settings-screen">
        <header class="settings-header"><button id="back-to-home-btn">&lt; è¿”å›</button><span class="title">è®¾ç½®</span></header>
        <main class="settings-list">
            <div class="settings-item" id="wallpaper-setting-btn"><span>å£çº¸è®¾ç½®</span><span>&gt;</span></div><div class="settings-item" id="icon-setting-btn"><span>å›¾æ ‡ä¿®æ”¹</span><span>&gt;</span></div><div class="settings-item" id="theme-setting-btn"><span>ä¸»é¢˜ç¾åŒ–</span><span>&gt;</span></div><div class="settings-item" id="font-setting-btn"><span>è‡ªå®šä¹‰å­—ä½“</span><span>&gt;</span></div>
        </main>
    </section>

    <!-- å›¾æ ‡ä¿®æ”¹ç•Œé¢ -->
    <section class="icon-settings-screen">
        <header class="settings-header"><button id="back-to-settings-btn">&lt; è®¾ç½®</button><span class="title">å›¾æ ‡ä¿®æ”¹</span></header>
        <main class="icon-edit-grid">
            <div class="app icon-editable" id="icon-edit-1" data-icon-index="1">ğŸ“±</div><div class="app icon-editable" id="icon-edit-2" data-icon-index="2">ğŸ“–</div><div class="app icon-editable" id="icon-edit-3" data-icon-index="3">ğŸ—ºï¸</div><div class="app icon-editable" id="icon-edit-4" data-icon-index="4">âš™ï¸</div>
        </main>
    </section>

    <!-- (æ–°å¢) ä¸»é¢˜ç¾åŒ–ç•Œé¢ -->
    <section class="theme-settings-screen">
        <header class="settings-header"><button id="back-to-settings-from-theme-btn">&lt; è®¾ç½®</button><span class="title">ä¸»é¢˜ç¾åŒ–</span></header>
        <main>
            <div class="theme-controls">
                <h4>å…¨å±€ä¸»é¢˜</h4>
                <div class="theme-control-item"><label for="theme-color-picker">è‡ªå®šä¹‰é¢œè‰²</label><input type="color" id="theme-color-picker" value="#3A3F4A"></div>
                <div class="theme-control-item"><label for="theme-opacity-slider">å…¨å±€ç¾åŒ–é€æ˜åº¦</label><input type="range" id="theme-opacity-slider" min="0" max="1" step="0.05" value="0.7"></div>
                <div class="action-buttons"><button id="theme-reset-btn" class="reset-btn">é‡ç½®</button><button id="theme-save-btn" class="save-btn">ä¿å­˜</button></div>
            </div>
            <div class="theme-controls">
                <h4>ç”µæ± ç¾åŒ–</h4>
                <div class="theme-control-item"><label for="battery-fill-color-picker">å†…éƒ¨é¢œè‰²</label><input type="color" id="battery-fill-color-picker" value="#ADD8E6"></div>
                <div class="theme-control-item"><label for="battery-fill-opacity-slider">å†…éƒ¨é€æ˜åº¦</label><input type="range" id="battery-fill-opacity-slider" min="0" max="1" step="0.05" value="1"></div>
                <div class="theme-control-item"><label for="battery-border-color-picker">è¾¹æ¡†é¢œè‰²</label><input type="color" id="battery-border-color-picker" value="#FFFFFF"></div>
                <div class="theme-control-item"><label for="battery-border-opacity-slider">è¾¹æ¡†é€æ˜åº¦</label><input type="range" id="battery-border-opacity-slider" min="0" max="1" step="0.05" value="1"></div>
                <div class="action-buttons"><button id="battery-reset-btn" class="reset-btn">é‡ç½®</button><button id="battery-save-btn" class="save-btn">ä¿å­˜</button></div>
            </div>
        </main>
    </section>

    <!-- (æ–°å¢) å­—ä½“è®¾ç½®ç•Œé¢ -->
    <section class="font-settings-screen">
        <header class="settings-header"><button id="back-to-settings-from-font-btn">&lt; è®¾ç½®</button><span class="title">è‡ªå®šä¹‰å­—ä½“</span></header>
        <main>
            <div class="theme-controls">
                <h4>å­—ä½“æ¥æº</h4>
                <div class="theme-control-item"><label for="font-file-input">æœ¬åœ°ä¸Šä¼  (.ttf, .otf)</label><input type="file" id="font-file-input" accept=".ttf,.otf,.woff,.woff2"></div>
                <div class="theme-control-item"><label for="font-url-input">ç½‘ç»œé“¾æ¥ (TTFé“¾æ¥)</label></div>
                <input type="text" id="font-url-input" class="font-input" placeholder="åœ¨æ­¤ç²˜è´´å­—ä½“æ–‡ä»¶é“¾æ¥...">
            </div>
            <div class="theme-controls">
                <h4>å­—ä½“æ ·å¼</h4>
                <div class="theme-control-item"><label for="font-color-picker">æ–‡å­—é¢œè‰²</label><input type="color" id="font-color-picker" value="#D3D7E0"></div>
                <div class="theme-control-item"><label for="font-weight-slider">æ–‡å­—ç²—ç»†</label><input type="range" id="font-weight-slider" min="100" max="900" step="100" value="300"></div>
                <div class="action-buttons"><button id="font-reset-btn" class="reset-btn">é‡ç½®</button><button id="font-save-btn" class="save-btn">ä¿å­˜</button></div>
            </div>
        </main>
    </section>

    <!-- è§’è‰²è®¾å®šç•Œé¢ -->
    <section class="character-settings-screen" id="character-settings-screen">
        <header class="settings-header"><button id="back-to-char-list-btn">&lt; è¿”å›</button><span class="title">è§’è‰²è®¾å®š</span></header>
        <main>
            <form class="character-settings-form" onsubmit="return false;">
                <h3 style="color: #333; text-align: center; width: 100%; margin: 0 0 10px 0;">å¥½å‹ä¿¡æ¯è®¾å®š</h3><div id="char-avatar-preview" class="avatar-preview"></div><input type="file" id="char-avatar-input" accept="image/*" style="display: none;"><div class="form-group"><label for="char-name-input">å¥½å‹åå­—</label><input type="text" id="char-name-input" placeholder="è¾“å…¥å¥½å‹çš„åå­—"></div><div class="form-group"><label for="char-setting-input">å¥½å‹è®¾å®š</label><textarea id="char-setting-input" placeholder="è¾“å…¥å¥½å‹çš„è¯¦ç»†è®¾å®š..."></textarea></div><div class="form-group"><label for="char-world-select">é€‰æ‹©ä¸–ç•Œä¹¦ (å¯¹å¥½å‹ç”Ÿæ•ˆ)</label><select id="char-world-select"><option value="none">æ— </option></select></div>
                <hr style="width: 100%; border-color: #E5E5EA; margin: 20px 0;">
                <h3 style="color: #333; text-align: center; width: 100%; margin: 0 0 10px 0;">æˆ‘çš„ä¿¡æ¯è®¾å®š</h3><div id="my-avatar-preview" class="avatar-preview"></div><input type="file" id="my-avatar-input" accept="image/*" style="display: none;"><div class="form-group"><label for="my-name-input">æˆ‘çš„åå­—</label><input type="text" id="my-name-input" placeholder="è¾“å…¥ä½ çš„åå­—"></div><div class="form-group"><label for="my-setting-input">æˆ‘çš„è®¾å®š</label><textarea id="my-setting-input" placeholder="è¾“å…¥ä½ è‡ªå·±çš„è¯¦ç»†è®¾å®š..."></textarea></div>
                <div class="form-actions"><button type="button" id="cancel-char-btn" class="reset-btn">å–æ¶ˆ</button><button type="button" id="save-char-btn" class="save-btn">ä¿å­˜</button></div>
            </form>
        </main>
    </section>

    <!-- å¾®ä¿¡-å¯¹è¯ç•Œé¢ -->
    <section class="dialogue-screen">
        <header class="settings-header" style="padding: 0 20px;"><button id="back-to-chat-list-btn">&lt; è¿”å›</button><span class="title" id="dialogue-character-name"></span><button id="dialogue-settings-btn">...</button></header>
        <main id="dialogue-content"></main>
        <!-- å¯¹è¯åº•éƒ¨å¯¼èˆªæ å¸ƒå±€ä¿®æ”¹ -->
        <footer class="dialogue-footer">
            <div id="functions-menu"><div class="function-menu-item" id="menu-voice-btn">è¯­éŸ³åŠŸèƒ½</div></div>
            <button id="functions-toggle-btn" class="footer-icon-btn">ğŸ¾</button>
            <input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
            <button id="send-message-btn">å‘é€</button>
            <button id="ai-reply-btn" class="footer-icon-btn">ğŸ“</button>
        </footer>
    </section>

    <!-- å¾®ä¿¡-å¥½å‹è®¾ç½®ç•Œé¢ -->
    <section class="friend-settings-screen">
        <header class="settings-header"><button id="back-to-dialogue-from-friend-settings-btn">&lt; è¿”å›</button><span class="title" id="friend-settings-character-name">å¥½å‹è®¾ç½®</span></header>
        <main style="padding: 20px; box-sizing: border-box; overflow-y: auto;">
            <div class="character-settings-form">
                <div class="form-group"><label for="friend-local-world-select">é€‰æ‹©å±€éƒ¨ä¸–ç•Œä¹¦</label><select id="friend-local-world-select"><option value="none">æ— </option></select></div>
                <hr style="width: 100%; border-color: #E5E5EA; margin: 20px 0;">

                <!-- æ–°å¢æ°”æ³¡è‡ªå®šä¹‰æ ·å¼ -->
                <h3 style="color: #333; text-align: center; width: 100%; margin: 0 0 10px 0;">æ°”æ³¡æ ·å¼å®šåˆ¶</h3>
                <div class="bubble-customization-section">
                    <!-- æˆ‘çš„æ°”æ³¡é¢œè‰² -->
                    <div class="bubble-color-setting">
                        <label for="my-bubble-color-picker">æˆ‘çš„æ°”æ³¡é¢œè‰²:</label>
                        <input type="color" id="my-bubble-color-picker" value="#007AFF">
                    </div>
                    <!-- å¯¹é¢æ°”æ³¡é¢œè‰² -->
                    <div class="bubble-color-setting">
                        <label for="their-bubble-color-picker">å¯¹é¢æ°”æ³¡é¢œè‰²:</label>
                        <input type="color" id="their-bubble-color-picker" value="#FFFFFF">
                    </div>

                    <!-- å®æ—¶æ°”æ³¡é¢„è§ˆ -->
                    <div class="bubble-preview-container">
                        <p style="font-size: 14px; color: #8A8FA0; margin-bottom: 10px;">å®æ—¶æ°”æ³¡é¢„è§ˆ:</p>
                        <div class="message-row their-message">
                            <div class="chat-avatar" style="background-image: url('data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2240%22%20height%3D%2240%22%20viewBox%3D%220%200%2040%2040%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Crect%20width%3D%2240%22%20height%3D%2240%22%20rx%3D%2220%22%20fill%3D%22%23ccc%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2255%25%22%20font-family%3D%22sans-serif%22%20font-size%3D%2216%22%20fill%3D%22white%22%20text-anchor%3D%22middle%22%20dominant-baseline%3D%22middle%22%3EA%3C%2Ftext%3E%3C%2Fsvg%3E')"></div>
                            <div class="chat-bubble preview-their-bubble" id="preview-their-bubble" style="border: 1px solid #E5E5EA;">å¯¹æ–¹çš„æ¶ˆæ¯</div>
                        </div>
                        <div class="message-row my-message" style="margin-top: 10px;">
                            <div class="chat-bubble preview-my-bubble" id="preview-my-bubble">æˆ‘çš„æ¶ˆæ¯</div>
                            <div class="chat-avatar" style="background-image: url('data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2240%22%20height%3D%2240%22%20viewBox%3D%220%200%2040%2040%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Crect%20width%3D%2240%22%20height%3D%2240%22%20rx%3D%2220%22%20fill%3D%22%23007AFF%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2255%25%22%20font-family%3D%22sans-serif%22%20font-size%3D%2216%22%20fill%3D%22white%22%20text-anchor%3D%22middle%22%20dominant-baseline%3D%22middle%22%3EM%3C%2Ftext%3E%3C%2Fsvg%3E')"></div>
                        </div>
                    </div>

                    <!-- è‡ªå®šä¹‰CSSè¾“å…¥ -->
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="custom-bubble-css">è‡ªå®šä¹‰æ°”æ³¡CSS (é«˜çº§):</label>
                        <textarea id="custom-bubble-css" placeholder="/* æˆ‘çš„æ°”æ³¡ */
.my-bubble {
    background-color: #62C462; /* æµ…ç»¿è‰² */
    border-radius: 15px 5px 15px 15px; /* å³ä¸Šè§’å°å°–è§’ */
}
/* å¯¹æ–¹æ°”æ³¡ */
.their-bubble {
    background-color: #E0E0E0; /* æµ…ç°è‰² */
    border-radius: 5px 15px 15px 15px; /* å·¦ä¸Šè§’å°å°–è§’ */
    border: none; /* ç§»é™¤é»˜è®¤è¾¹æ¡† */
}
/* æç¤º: å¯è‡ªå®šä¹‰é¢œè‰²ã€åœ†è§’ã€è¾¹æ¡†ã€å­—ä½“ç­‰ */"></textarea>
                        <div class="action-buttons" style="justify-content: flex-start; margin-top: 10px;">
                            <button id="copy-bubble-css-btn" class="action-btn" style="background-color: #555;">åŠ è½½ç¤ºä¾‹CSS</button>
                            <button id="clear-bubble-css-btn" class="reset-btn" style="background-color: #EA5455;">æ¸…é™¤è‡ªå®šä¹‰CSS</button>
                        </div>
                    </div>
                </div>
                <!-- ç»“æŸï¼šæ°”æ³¡æ ·å¼å®šåˆ¶åŒºåŸŸ -->

                <div class="form-actions">
                    <button type="button" id="edit-friend-info-btn" class="action-btn" style="background-color: #555;">ç¼–è¾‘èµ„æ–™</button>
                    <button type="button" id="clear-dialogue-btn" class="reset-btn" style="background-color: #EA5455;">ä¸€é”®æ¸…é™¤å¯¹è¯</button>
                </div>
            </div>
        </main>
    </section>

    <!-- ä¸–ç•Œä¹¦ç•Œé¢ -->
    <section class="world-book-screen">
        <header class="settings-header"><button id="back-to-home-from-world-book-btn">&lt; è¿”å›</button><span class="title">ä¸–ç•Œä¹¦</span><button id="create-world-book-btn" data-type="global" style="color:#007AFF;">åˆ›å»ºå…¨å±€ä¸–ç•Œä¹¦</button></header>
        <main class="world-book-main"><div class="world-book-tabs"><button id="show-global-world-books-btn" class="active tab-button" data-type="global">å…¨å±€ä¸–ç•Œä¹¦</button><button id="show-local-world-books-btn" class="tab-button" data-type="local">å±€éƒ¨ä¸–ç•Œä¹¦</button></div><div id="global-world-books-content" class="world-book-tab-content active"><p class="tab-content-title">å·²åˆ›å»ºçš„å…¨å±€ä¸–ç•Œä¹¦</p><div id="global-world-books-list" class="world-book-list"></div></div><div id="local-world-books-content" class="world-book-tab-content"><p class="tab-content-title">å·²åˆ›å»ºçš„å±€éƒ¨ä¸–ç•Œä¹¦</p><div id="local-world-books-list" class="world-book-list"></div></div></main>
    </section>

    <!-- ==================================================== -->
    <!-- ============ å¾®ä¿¡åŠŸèƒ½ç•Œé¢ START ==================== -->
    <!-- ==================================================== -->

    <section class="wechat-container-screen">
        <header class="wechat-header"><button id="wechat-back-to-home-btn">&lt; è¿”å›</button><span id="wechat-header-title">å¾®ä¿¡</span><div id="wechat-header-actions"></div></header>
        <main id="wechat-page-container">
            <div id="wechat-chat-list-page" class="wechat-page"><div id="character-list"></div></div>
            <div id="wechat-contacts-page" class="wechat-page"><div id="wechat-contacts-list"></div></div>
            <div id="wechat-moments-page" class="wechat-page">
                <div class="moments-header"><div class="moments-bg image-editable" id="moments-bg-editable"></div><div class="moments-user-info"><span class="moments-user-name editable" id="moments-user-name-editable"></span><div class="moments-avatar image-editable" id="moments-avatar-editable"></div></div></div>
                <div id="moments-posts-container"></div>
            </div>
            <div id="wechat-me-page" class="wechat-page">
                <div class="me-profile-header"><div class="me-avatar image-editable" id="me-avatar-editable"></div><div class="me-profile-info"><span class="me-name editable" id="me-name-editable"></span><span class="me-id">å¾®ä¿¡å·: <span class="editable" id="me-id-editable"></span></span></div></div>
                <div class="me-options-list"><div class="me-option-item" id="me-wallet-btn"><div class="option-label"><span>ğŸ’°</span> é’±åŒ…</div></div></div>
            </div>
        </main>
        <nav id="wechat-nav-bar"><div class="wechat-nav-item active" data-page="chat-list"><span>ğŸ’¬</span><div>å¾®ä¿¡</div></div><div class="wechat-nav-item" data-page="contacts"><span>ğŸ‘¥</span><div>é€šè®¯å½•</div></div><div class="wechat-nav-item" data-page="moments"><span>ğŸŒ</span><div>æœ‹å‹åœˆ</div></div><div class="wechat-nav-item" data-page="me"><span>ğŸ‘¤</span><div>æˆ‘</div></div></nav>
    </section>

    <section class="wechat-wallet-screen">
        <header class="simple-header"><button id="wechat-wallet-back-btn">&lt; è¿”å›</button><span class="title">é’±åŒ…</span></header>
        <main><div class="wallet-balance-card"><p>æˆ‘çš„ä½™é¢</p><h2>Â¥ 123.45</h2></div></main>
    </section>

    <section class="wechat-new-moment-screen">
        <header class="simple-header"><button id="wechat-cancel-moment-btn">å–æ¶ˆ</button><span class="title">å‘è¡¨æœ‹å‹åœˆ</span><button id="wechat-post-moment-btn" style="color: var(--wechat-theme-green); font-weight: 500;">å‘è¡¨</button></header>
        <main class="new-moment-content"><textarea id="new-moment-textarea" placeholder="è¿™ä¸€åˆ»çš„æƒ³æ³•..."></textarea><div class="me-options-list"><div class="me-option-item" id="moment-location-btn"><div class="option-label"><span>ğŸ“</span> æ‰€åœ¨ä½ç½®</div><span class="option-value" id="moment-location-value">ä¸æ˜¾ç¤ºä½ç½®</span></div><div class="me-option-item" id="moment-visibility-btn"><div class="option-label"><span>ğŸ‘¥</span> è°å¯ä»¥çœ‹</div><span class="option-value" id="moment-visibility-value">å…¬å¼€</span></div></div></main>
    </section>
    
    <section class="wechat-visibility-settings-screen">
        <header class="simple-header"><button id="wechat-visibility-back-btn">&lt; è¿”å›</button><span class="title">è°å¯ä»¥çœ‹</span></header>
        <main style="padding-top: 20px;"><div class="me-options-list visibility-options-list"><label class="me-option-item" for="visibility-public"><input type="radio" name="visibility" id="visibility-public" value="public" checked><div class="option-label"><span>ğŸŒ</span> å…¬å¼€</div></label><div class="me-option-item" id="visibility-show-some"><div class="option-label"><span>âœ…</span> éƒ¨åˆ†å¯è§</div><span>&gt;</span></div><div class="me-option-item" id="visibility-hide-some"><div class="option-label"><span>ğŸš«</span> ä¸ç»™è°çœ‹</div><span>&gt;</span></div></div></main>
    </section>

    <section class="wechat-select-friends-screen">
        <header class="simple-header"><button id="wechat-cancel-select-friends-btn">å–æ¶ˆ</button><span class="title" id="select-friends-title">é€‰æ‹©å¥½å‹</span><button id="wechat-confirm-select-friends-btn" style="color: var(--wechat-theme-green); font-weight: 500;">å®Œæˆ</button></header>
        <main class="select-friends-content" id="wechat-select-friends-list"></main>
    </section>

    <section class="wechat-group-settings-screen">
        <header class="simple-header"><button id="group-settings-back-btn">&lt; è¿”å›</button><span class="title">ç¾¤èŠè®¾ç½®</span></header>
        <main style="padding-top: 20px;">
            <div class="me-options-list">
                <div class="me-option-item" id="group-settings-name"><div class="option-label">ç¾¤èŠåç§°</div><span class="option-value" id="group-settings-name-value"></span></div>
                <div class="me-option-item" id="group-settings-avatar"><div class="option-label">æ›´æ¢ç¾¤å¤´åƒ</div><div class="character-avatar" id="group-settings-avatar-preview" style="width:40px; height:40px; border-radius:6px;"></div></div>
                <div class="me-option-item" id="group-settings-admin"><div class="option-label">è®¾ç½®ç®¡ç†å‘˜</div><span class="option-value" id="group-settings-admin-value">æœªè®¾ç½®</span></div>
                <div class="me-option-item" id="group-settings-worldbook">
                    <div class="option-label">å±€éƒ¨ä¸–ç•Œä¹¦</div>
                    <select id="group-local-world-select" class="model-select" style="max-width: 150px; background-color: transparent; border: none; text-align: right;"></select>
                </div>
            </div>
        </main>
    </section>

    <!-- ==================================================== -->
    <!-- ============= å¾®ä¿¡åŠŸèƒ½ç•Œé¢ END ===================== -->
    <!-- ==================================================== -->

    <!-- å„ç§å¼¹çª— -->
    <div class="modal-overlay" id="textModalOverlay"><div class="modal"><h3 id="text-modal-title"></h3><input type="text" id="modal-input"><div class="modal-actions"><button id="text-cancel-btn">å–æ¶ˆ</button><button id="text-save-btn" class="save-btn">ä¿å­˜</button></div></div></div>
    <div class="modal-overlay" id="imageModalOverlay"><div class="modal"><h3>æ›´æ¢å›¾ç‰‡</h3><div class="modal-method-switcher"><button id="method-file-btn" class="active">æœ¬åœ°ä¸Šä¼ </button><button id="method-url-btn">ç½‘ç»œé“¾æ¥</button></div><div id="file-upload-section"><input type="file" id="image-input" accept="image/*"></div><div id="url-input-section" style="display: none;"><input type="text" id="image-url-input" placeholder="è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥..."></div><div class="modal-actions"><button id="image-cancel-btn">å–æ¶ˆ</button><button id="image-save-btn" class="save-btn">ç¡®è®¤</button></div></div></div>
    
    <!-- ä¿®å¤/æ–°å¢ï¼šé€šç”¨åé¦ˆå¼¹çª—çš„HTMLç»“æ„ -->
    <div class="feedback-modal-overlay" id="feedbackModalOverlay">
        <div class="feedback-modal" id="feedbackModal">
            <p id="feedbackMessage"></p>
        </div>
    </div>

    <div class="modal-overlay" id="confirmationModalOverlay"><div class="modal"><h3 id="confirmation-title">ç¡®è®¤æ“ä½œ</h3><p id="confirmation-message"></p><div class="modal-actions"><button id="confirm-cancel-btn">å–æ¶ˆ</button><button id="confirm-action-btn" class="save-btn">ç¡®è®¤</button></div></div></div>
    <div class="modal-overlay" id="worldBookModalOverlay"><div class="modal"><h3 id="world-book-modal-title">åˆ›å»ºä¸–ç•Œä¹¦</h3><input type="text" id="world-book-name-input" placeholder="ä¸–ç•Œä¹¦åç§°"><textarea id="world-book-content-input" placeholder="ä¸–ç•Œä¹¦å†…å®¹..."></textarea><div class="modal-actions"><button id="world-book-cancel-btn">å–æ¶ˆ</button><button id="world-book-save-btn" class="save-btn">ä¿å­˜</button></div></div></div>
    <div class="modal-overlay" id="voiceTextModalOverlay"><div class="modal"><h3>è¯­éŸ³æ–‡å­—</h3><p id="voice-text-content" style="white-space: pre-wrap; word-wrap: break-word; max-height: 40vh; overflow-y: auto;"></p><div class="modal-actions"><button id="voice-text-close-btn" class="save-btn">å…³é—­</button></div></div></div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // --- åŸºç¡€åŠŸèƒ½ & å±å¹•åˆ‡æ¢ ---
            const dynamicIsland = document.querySelector('.dynamic-island');
            dynamicIsland.addEventListener('click', () => { dynamicIsland.classList.add('clicked'); setTimeout(() => dynamicIsland.classList.remove('clicked'), 200); });
            function updateTime() { document.querySelector('.time').textContent = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); }
            setInterval(updateTime, 1000); updateTime();

            const screens = {
                phone: document.querySelector('.phone-screen'),
                settings: document.querySelector('.settings-screen'),
                iconSettings: document.querySelector('.icon-settings-screen'),
                themeSettings: document.querySelector('.theme-settings-screen'), // æ–°å¢
                fontSettings: document.querySelector('.font-settings-screen'), // æ–°å¢
                characterSettings: document.getElementById('character-settings-screen'),
                dialogue: document.querySelector('.dialogue-screen'),
                worldBook: document.querySelector('.world-book-screen'),
                friendSettings: document.querySelector('.friend-settings-screen'),
                apiSettings: document.querySelector('.api-settings-screen'),
                wechatContainer: document.querySelector('.wechat-container-screen'),
                wechatWallet: document.querySelector('.wechat-wallet-screen'),
                wechatNewMoment: document.querySelector('.wechat-new-moment-screen'),
                wechatSelectFriends: document.querySelector('.wechat-select-friends-screen'),
                wechatVisibilitySettings: document.querySelector('.wechat-visibility-settings-screen'),
                wechatGroupSettings: document.querySelector('.wechat-group-settings-screen'),
            };
            const showScreen = (screenName) => { Object.values(screens).forEach(s => s.style.display = 'none'); if(screens[screenName]) screens[screenName].style.display = 'flex'; };
            
            // (æ›´æ–°) è®¾ç½®ç›¸å…³çš„å±å¹•åˆ‡æ¢
            document.getElementById('settings-app-btn').addEventListener('click', () => showScreen('settings'));
            document.getElementById('back-to-home-btn').addEventListener('click', () => showScreen('phone'));
            document.getElementById('icon-setting-btn').addEventListener('click', () => showScreen('iconSettings'));
            document.getElementById('back-to-settings-btn').addEventListener('click', () => showScreen('settings'));
            document.getElementById('theme-setting-btn').addEventListener('click', () => showScreen('themeSettings'));
            document.getElementById('back-to-settings-from-theme-btn').addEventListener('click', () => showScreen('settings'));
            document.getElementById('font-setting-btn').addEventListener('click', () => showScreen('fontSettings'));
            document.getElementById('back-to-settings-from-font-btn').addEventListener('click', () => showScreen('settings'));
            document.getElementById('back-to-char-list-btn').addEventListener('click', () => { showScreen('wechatContainer'); renderWechatPage('chat-list'); }); // æ–°å¢è¿”å›è§’è‰²åˆ—è¡¨æŒ‰é’®
            
            document.getElementById('world-book-app-btn').addEventListener('click', () => { renderWorldBooks(); showScreen('worldBook'); });
            document.getElementById('back-to-home-from-world-book-btn').addEventListener('click', () => showScreen('phone'));
            document.getElementById('back-to-dialogue-from-friend-settings-btn').addEventListener('click', () => showScreen('dialogue'));
            document.getElementById('cancel-char-btn').addEventListener('click', () => { showScreen('wechatContainer'); renderWechatPage(currentWechatPage); resetCharacterForm(); });
            document.getElementById('back-to-chat-list-btn').addEventListener('click', () => { showScreen('wechatContainer'); renderWechatPage('chat-list'); activeCharacter = null; });
            document.getElementById('dialogue-settings-btn').addEventListener('click', () => {
                if (!activeCharacter) return;
                if (activeCharacter.isGroup) { renderGroupSettings(); showScreen('wechatGroupSettings'); } 
                else { renderFriendSettings(); showScreen('friendSettings'); }
            });
            document.getElementById('api-settings-btn').addEventListener('click', () => showScreen('apiSettings'));
            document.getElementById('back-to-home-from-api-btn').addEventListener('click', () => showScreen('phone'));

            // --- æ–‡æœ¬ä¿®æ”¹å¼¹çª—é€»è¾‘ ---
            const textModalOverlay = document.getElementById('textModalOverlay');
            const textModalTitle = document.getElementById('text-modal-title');
            const modalInput = document.getElementById('modal-input');
            const textSaveBtn = document.getElementById('text-save-btn');
            const textCancelBtn = document.getElementById('text-cancel-btn');
            let currentEditingElement = null;
            let onTextSaveCallback = null;

            function openTextEditor(element, title = "ä¿®æ”¹ä¿¡æ¯", callback = null, initialValue = null) { // Added initialValue parameter
                currentEditingElement = element; onTextSaveCallback = callback;
                textModalTitle.textContent = title;
                modalInput.value = initialValue !== null ? initialValue : (element && (element.textContent.trim() === 'ä¸æ˜¾ç¤ºä½ç½®' || element.textContent.trim() === 'æœªè®¾ç½®')) ? '' : (element ? element.textContent.trim() : '');
                textModalOverlay.style.display = 'flex'; modalInput.focus();
            }
            // Removed direct event listeners here to avoid interference with specific editable elements
            // The specific .editable elements are handled individually elsewhere.
            
            textSaveBtn.onclick = () => {
                try {
                    if (onTextSaveCallback) { onTextSaveCallback(modalInput.value); } 
                    else if (currentEditingElement) {
                        currentEditingElement.textContent = modalInput.value;
                        if (currentEditingElement.id === 'moments-user-name-editable') wechatData.moments.name = modalInput.value;
                        else if (currentEditingElement.id === 'me-name-editable') wechatData.me.name = modalInput.value;
                        else if (currentEditingElement.id === 'me-id-editable') wechatData.me.id = modalInput.value;
                        saveWechatDataToLocalStorage(); updateAllWechatNames(wechatData.me.name);
                    }
                } finally { closeTextModal(); }
            };
            textCancelBtn.onclick = () => closeTextModal();
            textModalOverlay.addEventListener('click', (e) => { if (e.target === textModalOverlay) closeTextModal(); });
            function closeTextModal() { textModalOverlay.style.display = 'none'; currentEditingElement = null; onTextSaveCallback = null; }
            
            // --- å›¾ç‰‡ä¸Šä¼ å¼¹çª—é€»è¾‘ (å·²æ•´åˆå£çº¸å’Œå›¾æ ‡ä¿®æ”¹) ---
            const imageModalOverlay = document.getElementById('imageModalOverlay');
            const imageInput = document.getElementById('image-input');
            const imageUrlInput = document.getElementById('image-url-input');
            const imageSaveBtn = document.getElementById('image-save-btn');
            const imageCancelBtn = document.getElementById('image-cancel-btn');
            const methodFileBtn = document.getElementById('method-file-btn');
            const methodUrlBtn = document.getElementById('method-url-input'); // Changed to input directly
            const fileUploadSection = document.getElementById('file-upload-section');
            const urlInputSection = document.getElementById('url-input-section');
            let newImageFromFile = null;
            let editTarget = { type: null, element: null, index: null, wechatTarget: null };

            const setupImageEditor = (type, element = null, index = null, wechatTarget = null) => {
                editTarget = { type, element, index, wechatTarget };
                imageModalOverlay.style.display = 'flex';
            };

            // ç›‘å¬æ‰€æœ‰å¯ç¼–è¾‘å›¾ç‰‡çš„ç‚¹å‡»
            document.querySelectorAll('.image-editable').forEach(el => el.addEventListener('click', (e) => {
                e.stopPropagation(); let wechatTarget = null;
                if (el.id === 'moments-bg-editable') wechatTarget = 'moments-bg';
                else if (el.id === 'moments-avatar-editable') wechatTarget = 'moments-avatar';
                else if (el.id === 'me-avatar-editable') wechatTarget = 'me-avatar';
                else if (el.id === 'group-settings-avatar-preview') wechatTarget = 'group-avatar';
                setupImageEditor('element', el, null, wechatTarget);
            }));
            // ç›‘å¬è®¾ç½®é‡Œçš„å£çº¸å’Œå›¾æ ‡æŒ‰é’®
            document.getElementById('wallpaper-setting-btn').addEventListener('click', () => setupImageEditor('wallpaper'));
            document.querySelectorAll('.icon-editable').forEach(icon => icon.addEventListener('click', () => setupImageEditor('icon', null, icon.dataset.iconIndex)));

            methodFileBtn.addEventListener('click', () => { methodFileBtn.classList.add('active'); methodUrlBtn.classList.remove('active'); fileUploadSection.style.display = 'block'; urlInputSection.style.display = 'none'; });
            // NOTE: There was a typo here, methodUrlBtn was image-url-input. Corrected to actual button.
            // Assuming there's a button for URL method, if not, you'll need to add one in HTML.
            // For now, I'll use imageUrlInput as the trigger, if there's no specific button.
            const methodUrlButton = document.getElementById('method-url-btn'); // Assuming this exists or will be added.
            if (methodUrlButton) {
                methodUrlButton.addEventListener('click', () => {
                    methodUrlButton.classList.add('active');
                    methodFileBtn.classList.remove('active');
                    fileUploadSection.style.display = 'none';
                    urlInputSection.style.display = 'block';
                });
            } else { // Fallback if no specific button, using the input itself as a "trigger" for UI mode
                imageUrlInput.addEventListener('focus', () => {
                    if (methodFileBtn.classList.contains('active')) {
                        methodFileBtn.classList.remove('active');
                    }
                    // No 'active' class to add to an input, just ensure correct section is shown
                    fileUploadSection.style.display = 'none';
                    urlInputSection.style.display = 'block';
                });
            }


            imageInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (re) => { newImageFromFile = re.target.result; }; reader.readAsDataURL(file); } else { newImageFromFile = null; }});
            
            imageSaveBtn.addEventListener('click', () => {
                const finalImageUrl = methodFileBtn.classList.contains('active') ? newImageFromFile : imageUrlInput.value.trim();
                if (!finalImageUrl) { closeImageModal(); return; }

                if (editTarget.wechatTarget) {
                    switch(editTarget.wechatTarget) {
                        case 'moments-bg': wechatData.moments.bg = finalImageUrl; break;
                        case 'moments-avatar': wechatData.moments.avatar = finalImageUrl; break;
                        case 'me-avatar': wechatData.me.avatar = finalImageUrl; break;
                        case 'group-avatar': if (activeCharacter) { activeCharacter.avatar = finalImageUrl; saveCharactersToLocalStorage(); renderGroupSettings(); } break;
                    }
                    saveWechatDataToLocalStorage(); renderWechatPage(currentWechatPage);
                }

                if (editTarget.type === 'wallpaper') { Object.values(screens).forEach(s => s.style.backgroundImage = `url(${finalImageUrl})`); }
                else if (editTarget.type === 'icon' && editTarget.index) { 
                    const homeIcon = document.getElementById(`home-app-icon-${editTarget.index}`); 
                    const settingsIcon = document.getElementById(`icon-edit-${editTarget.index}`); 
                    if (homeIcon) { homeIcon.style.backgroundImage = `url(${finalImageUrl})`; homeIcon.textContent = ''; } 
                    if (settingsIcon) { settingsIcon.style.backgroundImage = `url(${finalImageUrl})`; settingsIcon.textContent = ''; } 
                }
                else if (editTarget.type === 'element' && editTarget.element) { 
                    editTarget.element.style.backgroundImage = `url(${finalImageUrl})`; 
                    if (editTarget.element.classList.contains('widget')) editTarget.element.textContent = ''; 
                }
                closeImageModal();
            });

            imageCancelBtn.addEventListener('click', closeImageModal);
            function closeImageModal() { imageModalOverlay.style.display = 'none'; imageInput.value = ''; imageUrlInput.value = ''; newImageFromFile = null; editTarget = { type: null, element: null, index: null, wechatTarget: null }; methodFileBtn.click(); }
            
            // --- ä¸»é¢˜/å­—ä½“/ç”µæ± ç¾åŒ– ---
            const root = document.documentElement; const themeColorPicker = document.getElementById('theme-color-picker'); const themeOpacitySlider = document.getElementById('theme-opacity-slider'); const batteryFillColorPicker = document.getElementById('battery-fill-color-picker'); const batteryFillOpacitySlider = document.getElementById('battery-fill-opacity-slider'); const batteryBorderColorPicker = document.getElementById('battery-border-color-picker'); const batteryBorderOpacitySlider = document.getElementById('battery-border-opacity-slider'); const hexToRgb = (hex) => { const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : null; }; const applyThemeColor = (color) => { const rgb = hexToRgb(color); root.style.setProperty('--theme-base-color', color); root.style.setProperty('--theme-secondary-color', color); if (rgb) root.style.setProperty('--theme-base-color-rgb', rgb); }; const applyGlobalOpacity = (opacity) => root.style.setProperty('--global-opacity', opacity); const applyBatteryStyle = (color, opacity, property) => { const rgb = hexToRgb(color); if(rgb) root.style.setProperty(property, `rgba(${rgb}, ${opacity})`); }; themeColorPicker.addEventListener('input', (e) => applyThemeColor(e.target.value)); themeOpacitySlider.addEventListener('input', (e) => applyGlobalOpacity(e.target.value)); batteryFillColorPicker.addEventListener('input', () => applyBatteryStyle(batteryFillColorPicker.value, batteryFillOpacitySlider.value, '--battery-fill-color')); batteryFillOpacitySlider.addEventListener('input', () => applyBatteryStyle(batteryFillColorPicker.value, batteryFillOpacitySlider.value, '--battery-fill-color')); batteryBorderColorPicker.addEventListener('input', () => applyBatteryStyle(batteryBorderColorPicker.value, batteryBorderOpacitySlider.value, '--battery-border-color')); batteryBorderOpacitySlider.addEventListener('input', () => applyBatteryStyle(batteryBorderColorPicker.value, batteryBorderOpacitySlider.value, '--battery-border-color')); document.getElementById('theme-save-btn').addEventListener('click', () => { localStorage.setItem('savedTheme', JSON.stringify({ color: themeColorPicker.value, opacity: themeOpacitySlider.value })); showFeedbackModal('å…¨å±€ä¸»é¢˜å·²ä¿å­˜ï¼'); }); document.getElementById('battery-save-btn').addEventListener('click', () => { localStorage.setItem('savedBatteryTheme', JSON.stringify({ fillColor: batteryFillColorPicker.value, fillOpacity: batteryFillOpacitySlider.value, borderColor: batteryBorderColorPicker.value, borderOpacity: batteryBorderOpacitySlider.value })); showFeedbackModal('ç”µæ± ä¸»é¢˜å·²ä¿å­˜ï¼'); }); document.getElementById('theme-reset-btn').addEventListener('click', () => { if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤ä¸»é¢˜å—ï¼Ÿ')) { localStorage.removeItem('savedTheme'); location.reload(); } }); document.getElementById('battery-reset-btn').addEventListener('click', () => { if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤ç”µæ± æ ·å¼å—ï¼Ÿ')) { localStorage.removeItem('savedBatteryTheme'); location.reload(); } }); const fontFileInput = document.getElementById('font-file-input'); const fontUrlInput = document.getElementById('font-url-input'); const fontColorPicker = document.getElementById('font-color-picker'); const fontWeightSlider = document.getElementById('font-weight-slider'); const customFontStyleBlock = document.getElementById('custom-font-style-block'); let currentFontSettings = { source: null, value: null }; const applyFont = (source, value, color, weight) => { if (value) { customFontStyleBlock.innerHTML = `@font-face { font-family: 'custom-user-font'; src: url('${value}'); }`; root.style.setProperty('--global-font-family', "'custom-user-font', -apple-system, BlinkMacSystemFont, sans-serif"); currentFontSettings = { source, value }; } root.style.setProperty('--global-font-color', color); root.style.setProperty('--global-font-weight', weight); }; fontFileInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (re) => { fontUrlInput.value = ''; applyFont('file', re.target.result, fontColorPicker.value, fontWeightSlider.value); }; reader.readAsDataURL(file); } }); fontUrlInput.addEventListener('blur', () => { if(fontUrlInput.value.trim()){ fontFileInput.value = ''; applyFont('url', fontUrlInput.value.trim(), fontColorPicker.value, fontWeightSlider.value); } }); fontColorPicker.addEventListener('input', (e) => root.style.setProperty('--global-font-color', e.target.value)); fontWeightSlider.addEventListener('input', (e) => root.style.setProperty('--global-font-weight', e.target.value)); document.getElementById('font-save-btn').addEventListener('click', () => { if (!currentFontSettings.source && !fontUrlInput.value.trim()) { showFeedbackModal('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå­—ä½“æ–‡ä»¶æˆ–è¾“å…¥é“¾æ¥ï¼', false); return; } if(fontUrlInput.value.trim() && !currentFontSettings.source) applyFont('url', fontUrlInput.value.trim(), fontColorPicker.value, fontWeightSlider.value); const settingsToSave = { ...currentFontSettings, color: fontColorPicker.value, weight: fontWeightSlider.value }; localStorage.setItem('savedFontSettings', JSON.stringify(settingsToSave)); showFeedbackModal('å­—ä½“è®¾ç½®å·²ä¿å­˜ï¼'); }); document.getElementById('font-reset-btn').addEventListener('click', () => { if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤å­—ä½“å—ï¼Ÿ')) { localStorage.removeItem('savedFontSettings'); location.reload(); } });

            // --- å¼¹çª—ä¸åé¦ˆ (ä¿®å¤å’Œä¼˜åŒ–) ---
            const confirmationModalOverlay = document.getElementById('confirmationModalOverlay');
            const confirmationMessageEl = document.getElementById('confirmation-message');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            const confirmActionBtn = document.getElementById('confirm-action-btn');
            function showConfirmationModal(message, onConfirm) { 
                confirmationMessageEl.textContent = message; 
                confirmationModalOverlay.style.display = 'flex'; 
                confirmActionBtn.onclick = function() { 
                    if(onConfirm) onConfirm(); 
                    hideConfirmationModal(); 
                }; 
            }
            function hideConfirmationModal() { 
                confirmationModalOverlay.style.display = 'none'; 
                confirmActionBtn.onclick = null; 
            }
            confirmCancelBtn.onclick = hideConfirmationModal;
            
            const feedbackModalOverlay = document.getElementById('feedbackModalOverlay');
            const feedbackModal = document.getElementById('feedbackModal');
            const feedbackMessage = document.getElementById('feedbackMessage');
            
            // ä¿®å¤ï¼šé‡å†™ showFeedbackModal å‡½æ•°ä»¥ç¡®ä¿åŠ¨ç”»æ•ˆæœæ­£å¸¸è§¦å‘
            // ä¹‹å‰çš„é—®é¢˜å¯èƒ½æ˜¯å› ä¸º display: none -> display: flex å’Œ opacity: 0 -> opacity: 1 çš„å˜åŒ–åœ¨åŒä¸€æ¬¡æ¸²æŸ“ä¸­å®Œæˆï¼Œå¯¼è‡´æµè§ˆå™¨è·³è¿‡äº†è¿‡æ¸¡åŠ¨ç”»ã€‚
            // ä½¿ç”¨ requestAnimationFrame å¯ä»¥ç¡®ä¿ display å±æ€§å…ˆç”Ÿæ•ˆï¼Œç„¶ååœ¨ä¸‹ä¸€å¸§å†æ·»åŠ  .visible ç±»æ¥è§¦å‘åŠ¨ç”»ã€‚
            function showFeedbackModal(message, isSuccess = true, callback = null) {
                feedbackMessage.textContent = message;
                feedbackModal.classList.remove('error'); // å…ˆé‡ç½®çŠ¶æ€
                if (!isSuccess) {
                    feedbackModal.classList.add('error');
                }

                // 1. å…ˆè®©é®ç½©å±‚æ˜¾ç¤ºå‡ºæ¥
                feedbackModalOverlay.style.display = 'flex';
                
                // 2. ä½¿ç”¨ requestAnimationFrame æ¨è¿Ÿ .visible ç±»çš„æ·»åŠ ï¼Œç¡®ä¿æµè§ˆå™¨æœ‰æ—¶é—´æ¸²æŸ“ display:flex
                requestAnimationFrame(() => {
                    // è¿™æ ·å¯ä»¥ä¿è¯è¿‡æ¸¡åŠ¨ç”»è¢«æ­£ç¡®è§¦å‘
                    feedbackModalOverlay.classList.add('visible');
                });

                // 3. è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œåœ¨å¼¹çª—æ˜¾ç¤ºä¸€æ®µæ—¶é—´åå¼€å§‹éšè—è¿‡ç¨‹
                setTimeout(() => {
                    // ç§»é™¤ .visible ç±»ï¼Œè§¦å‘å‘åï¼ˆéšè—ï¼‰çš„è¿‡æ¸¡åŠ¨ç”»
                    feedbackModalOverlay.classList.remove('visible'); 

                    // 4. å†è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œç­‰å¾…éšè—åŠ¨ç”»ï¼ˆ0.2sï¼‰ç»“æŸåï¼Œå†å½»åº•å°† display è®¾ç½®ä¸º none å¹¶æ‰§è¡Œå›è°ƒ
                    setTimeout(() => {
                        feedbackModalOverlay.style.display = 'none'; 
                        if (callback) {
                            callback(); // åœ¨å¼¹çª—å®Œå…¨æ¶ˆå¤±åæ‰§è¡Œå›è°ƒå‡½æ•°
                        }
                    }, 300); // è¿™ä¸ªæ—¶é—´ï¼ˆ300msï¼‰è¦æ¯” CSS ä¸­çš„è¿‡æ¸¡æ—¶é—´ï¼ˆ200msï¼‰ç¨é•¿ï¼Œç¡®ä¿åŠ¨ç”»å®Œæˆ
                }, 1500); // å¼¹çª—å®Œå…¨å¯è§çš„æŒç»­æ—¶é—´
            }
            
            // --- èŠå¤© & è§’è‰²è®¾å®šé€»è¾‘ ---
            const myAvatarPreview = document.getElementById('my-avatar-preview'); const myAvatarInput = document.getElementById('my-avatar-input'); const myNameInput = document.getElementById('my-name-input'); const mySettingInput = document.getElementById('my-setting-input'); const characterListContainer = document.getElementById('character-list'); const charAvatarPreview = document.getElementById('char-avatar-preview'); const charAvatarInput = document.getElementById('char-avatar-input'); const charNameInput = document.getElementById('char-name-input'); const charSettingInput = document.getElementById('char-setting-input'); const charWorldSelect = document.getElementById('char-world-select'); const dialogueContent = document.getElementById('dialogue-content'); const dialogueCharacterName = document.getElementById('dialogue-character-name'); const messageInput = document.getElementById('message-input'); const sendMessageBtn = document.getElementById('send-message-btn');
            let characters = []; let activeCharacter = null; let newCharAvatarDataUrl = null; let newMyAvatarDataUrl = null; let editingCharacterId = null; let myInfo = { name: 'æˆ‘', setting: 'æˆ‘æ˜¯ä¸€ä¸ªç”¨æˆ·', avatar: null };

            // --- ä¸ºè§’è‰²è®¾å®šçš„â€œä¿å­˜â€æŒ‰é’®æ·»åŠ åŠŸèƒ½å’Œç»¿è‰²å¼¹çª—ï¼Œå¹¶è°ƒæ•´å±å¹•åˆ‡æ¢å»¶è¿Ÿ ---
            document.getElementById('save-char-btn').onclick = function() {
                const charName = charNameInput.value.trim();
                const charSetting = charSettingInput.value.trim();

                // åŸºæœ¬ä¿¡æ¯æ ¡éªŒ
                if (!charName || !charSetting) {
                    showFeedbackModal('è¯·å¡«å†™å¥½å‹çš„åå­—å’Œè®¾å®šï¼', false);
                    return;
                }
                
                // å¦‚æœæ˜¯åˆ›å»ºæ–°è§’è‰²ï¼Œå¿…é¡»æœ‰å¤´åƒ
                if (!editingCharacterId && !newCharAvatarDataUrl) {
                    showFeedbackModal('è¯·ä¸ºæ–°å¥½å‹ä¸Šä¼ å¤´åƒï¼', false);
                    return;
                }

                // ä¿å­˜æˆ‘çš„ä¿¡æ¯
                myInfo.name = myNameInput.value.trim() || 'æˆ‘';
                myInfo.setting = mySettingInput.value.trim() || 'æˆ‘æ˜¯ä¸€ä¸ªç”¨æˆ·';
                if (newMyAvatarDataUrl) myInfo.avatar = newMyAvatarDataUrl;
                localStorage.setItem('myInfo', JSON.stringify(myInfo));

                let feedbackMsg = '';
                let transitionCallback = null; // Callback for screen transition after modal hides

                // åˆ¤æ–­æ˜¯ç¼–è¾‘è¿˜æ˜¯æ–°å»º
                if (editingCharacterId) {
                    // ç¼–è¾‘ç°æœ‰è§’è‰²
                    const charToUpdate = characters.find(c => c.id === editingCharacterId);
                    if (charToUpdate) {
                        charToUpdate.name = charName;
                        charToUpdate.setting = charSetting;
                        charToUpdate.worldBookId = charWorldSelect.value;
                        if (newCharAvatarDataUrl) charToUpdate.avatar = newCharAvatarDataUrl;
                        
                        saveCharactersToLocalStorage();
                        feedbackMsg = 'å¥½å‹ä¿¡æ¯æ›´æ–°æˆåŠŸ';
                        transitionCallback = () => {
                           // ä¿®æ­£ï¼šä»è§’è‰²è®¾å®šè¿”å›ï¼Œå¦‚æœæ˜¯ç¼–è¾‘ç°æœ‰è§’è‰²ï¼Œåº”è¯¥è¿”å›åˆ°å¥½å‹è®¾ç½®ï¼Œè€Œä¸æ˜¯ç›´æ¥èŠå¤©åˆ—è¡¨
                           if (activeCharacter && activeCharacter.id === editingCharacterId) {
                               showScreen('friendSettings');
                               renderFriendSettings(); // Re-render friend settings to reflect changes
                           } else {
                               showScreen('wechatContainer');
                               renderWechatPage('chat-list');
                           }                           
                        };
                    }
                } else {
                    // åˆ›å»ºæ–°è§’è‰²
                    const newCharacter = {
                        id: Date.now(),
                        name: charName,
                        avatar: newCharAvatarDataUrl,
                        setting: charSetting,
                        worldBookId: charWorldSelect.value,
                        age: null,
                        birthday: null,
                        localWorldBookId: 'none',
                        messages: [],
                        pinned: false, // New property for pinning
                        bubbleSettings: { // Initialize bubble settings for new character
                            myBubbleColor: '#007AFF',
                            theirBubbleColor: '#FFFFFF',
                            customCss: ''
                        }
                    };
                    characters.unshift(newCharacter);
                    saveCharactersToLocalStorage();                    
                    feedbackMsg = 'å¥½å‹åˆ›å»ºæˆåŠŸ';
                    transitionCallback = () => {
                        showScreen('wechatContainer');
                        renderWechatPage('chat-list');
                    };
                }
                resetCharacterForm();
                
                // NEW: Hide the current character settings screen BEFORE showing the feedback modal
                screens.characterSettings.style.display = 'none';

                // Call showFeedbackModal with the transitionCallback
                showFeedbackModal(feedbackMsg, true, transitionCallback);
            };

            charAvatarPreview.addEventListener('click', () => charAvatarInput.click()); charAvatarInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (re) => { newCharAvatarDataUrl = re.target.result; charAvatarPreview.style.backgroundImage = `url(${newCharAvatarDataUrl})`; charAvatarPreview.classList.add('has-image'); }; reader.readAsDataURL(file); } }); myAvatarPreview.addEventListener('click', () => myAvatarInput.click()); myAvatarInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (re) => { newMyAvatarDataUrl = re.target.result; myAvatarPreview.style.backgroundImage = `url(${newMyAvatarDataUrl})`; myAvatarPreview.classList.add('has-image'); }; reader.readAsDataURL(file); } }); function resetCharacterForm() { charNameInput.value = ''; charSettingInput.value = ''; charWorldSelect.value = 'none'; charAvatarPreview.style.backgroundImage = ''; charAvatarPreview.classList.remove('has-image'); charAvatarInput.value = ''; newCharAvatarDataUrl = null; myAvatarInput.value = ''; newMyAvatarDataUrl = null; editingCharacterId = null; } function populateMyInfoForm() { myNameInput.value = myInfo.name; mySettingInput.value = myInfo.setting; if (myInfo.avatar) { myAvatarPreview.style.backgroundImage = `url(${myInfo.avatar})`; myAvatarPreview.classList.add('has-image'); } else { myAvatarPreview.style.backgroundImage = ''; myAvatarPreview.classList.remove('has-image'); } }
            
            // Modified renderCharacterList for swipe actions and pinning
            function renderCharacterList(container) {
                container.innerHTML = '';
                // Sort characters: pinned first, then by name (or last message time)
                const sortedCharacters = [...characters].sort((a, b) => {
                    if (a.pinned && !b.pinned) return -1;
                    if (!a.pinned && b.pinned) return 1;
                    return a.name.localeCompare(b.name); // Or by last message timestamp
                });

                if (sortedCharacters.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color:#8A8FA0; margin-top: 40px;">è¿˜æ²¡æœ‰å¥½å‹å’Œç¾¤èŠ</p>';
                    return;
                }

                sortedCharacters.forEach(char => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'character-item-wrapper';
                    wrapper.dataset.id = char.id;

                    const item = document.createElement('div');
                    item.className = 'character-item';
                    if (char.pinned) item.classList.add('pinned');

                    const avatarClass = char.isGroup ? 'character-avatar group-avatar' : 'character-avatar';
                    item.innerHTML = `
                        <div class="${avatarClass}" style="background-image: url(${char.avatar || ''}); border-radius: 8px;"></div>
                        <span class="character-name">${char.name}</span>
                    `;
                    item.addEventListener('click', (e) => {
                        // Prevent opening dialogue if a swipe is active or action button clicked
                        if (wrapper.classList.contains('swiped') || e.target.closest('.swipe-actions')) {
                            // If a swipe is active, clicking on the item itself should close the swipe actions
                            closeAllSwipeActions();
                            return;
                        }
                        openDialogue(char.id);
                    });

                    const swipeActions = document.createElement('div');
                    swipeActions.className = 'swipe-actions';
                    swipeActions.innerHTML = `
                        <button class="action-pin" data-id="${char.id}">${char.pinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶'}</button>
                        <button class="action-delete" data-id="${char.id}">åˆ é™¤</button>
                    `;
                    swipeActions.querySelector('.action-pin').addEventListener('click', () => togglePinCharacter(char.id));
                    swipeActions.querySelector('.action-delete').addEventListener('click', () => deleteCharacter(char.id));

                    wrapper.appendChild(item);
                    wrapper.appendChild(swipeActions);
                    container.appendChild(wrapper);

                    // Add swipe event listeners
                    addSwipeListeners(wrapper);
                });
            }

            // Swipe logic
            let startX = 0;
            let currentTranslateX = 0;
            let activeSwipeWrapper = null;

            function addSwipeListeners(wrapper) {
                let startX = 0;
                let isSwiping = false;

                function handleTouchStart(e) {
                    startX = e.touches[0].clientX;
                    isSwiping = false;
                    closeAllSwipeActions(wrapper); // Close other swiped items
                }

                function handleTouchMove(e) {
                    const currentX = e.touches[0].clientX;
                    const diffX = currentX - startX;

                    if (Math.abs(diffX) > 10) { // Start swiping if movement is significant
                        isSwiping = true;
                        wrapper.classList.add('swiping'); // Optional: add a class for visual feedback during swipe
                    }

                    if (isSwiping) {
                        e.preventDefault(); // Prevent scrolling while swiping
                        // Only allow swiping left
                        const translateX = Math.min(0, Math.max(-120, diffX)); // Limit swipe to -120px
                        wrapper.querySelector('.character-item').style.transform = `translateX(${translateX}px)`;
                        // The actions are positioned absolutely to the right, so they don't need a direct transform for movement.
                        // The wrapper.swiped class will handle the final position.
                    }
                }

                function handleTouchEnd(e) {
                    const item = wrapper.querySelector('.character-item');
                    const itemTransform = item.style.transform;
                    const regex = /translateX\(([-\d.]+)px\)/;
                    const match = regex.exec(itemTransform);
                    let currentX = match ? parseFloat(match[1]) : 0;

                    wrapper.classList.remove('swiping');

                    if (currentX < -60) { // If swiped more than half way, snap open
                        wrapper.classList.add('swiped');
                        item.style.transform = `translateX(-120px)`;
                        activeSwipeWrapper = wrapper;
                    } else { // Snap closed
                        wrapper.classList.remove('swiped');
                        item.style.transform = `translateX(0)`;
                        activeSwipeWrapper = null;
                    }
                    isSwiping = false;
                }

                wrapper.addEventListener('touchstart', handleTouchStart, { passive: false });
                wrapper.addEventListener('touchmove', handleTouchMove, { passive: false });
                wrapper.addEventListener('touchend', handleTouchEnd);
            }

            function closeAllSwipeActions(excludeWrapper = null) {
                document.querySelectorAll('.character-item-wrapper.swiped').forEach(wrapper => {
                    if (wrapper !== excludeWrapper) {
                        wrapper.classList.remove('swiped');
                        wrapper.querySelector('.character-item').style.transform = `translateX(0)`;
                    }
                });
            }

            // Click outside to close swipe actions
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.character-item-wrapper') && activeSwipeWrapper) {
                    closeAllSwipeActions();
                }
            });


            function togglePinCharacter(charId) {
                const char = characters.find(c => c.id === charId);
                if (char) {
                    char.pinned = !char.pinned;
                    saveCharactersToLocalStorage();
                    renderCharacterList(characterListContainer); // Re-render to update order and button text
                    showFeedbackModal(char.pinned ? 'å¥½å‹å·²ç½®é¡¶' : 'å·²å–æ¶ˆç½®é¡¶');
                }
            }

            function deleteCharacter(charId) {
                showConfirmationModal('ç¡®å®šè¦åˆ é™¤æ­¤å¥½å‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚', () => {
                    characters = characters.filter(c => c.id !== charId);
                    saveCharactersToLocalStorage();
                    renderCharacterList(characterListContainer); // Re-render to update list
                    showFeedbackModal('å¥½å‹å·²åˆ é™¤');
                });
            }

            function openDialogue(charId) { activeCharacter = characters.find(c => c.id == charId); if (!activeCharacter) return; dialogueCharacterName.textContent = activeCharacter.name; dialogueContent.innerHTML = ''; if (activeCharacter.messages) { activeCharacter.messages.forEach(msg => appendMessage(msg)); } else { activeCharacter.messages = []; } showScreen('dialogue'); setTimeout(() => dialogueContent.scrollTop = dialogueContent.scrollHeight, 0); } sendMessageBtn.addEventListener('click', sendMessage); messageInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') sendMessage(); });
            
            function getContrastingTextColor(bgColor) {
                // Function to determine if white or black text is better for contrast
                // From: https://stackoverflow.com/questions/11867545/change-text-color-based-on-brightness-of-the-given-color-jquery
                const color = (bgColor.charAt(0) === '#') ? bgColor.substring(1, 7) : bgColor;
                const r = parseInt(color.substring(0, 2), 16); // red
                const g = parseInt(color.substring(2, 4), 16); // green
                const b = parseInt(color.substring(4, 6), 16); // blue
                const uicolors = [r / 255, g / 255, b / 255];
                const c = uicolors.map((col) => {
                    if (col <= 0.03928) {
                        return col / 12.92;
                    }
                    return Math.pow((col + 0.055) / 1.055, 2.4);
                });
                const L = (0.2126 * c[0]) + (0.7152 * c[1]) + (0.0722 * c[2]);
                return (L > 0.179) ? '#000000' : '#FFFFFF'; // Darken threshold slightly
            }

            function sendMessage() {
                const text = messageInput.value.trim();
                if (!text || !activeCharacter) return;

                const message = { type: 'text', content: text, sender: 'me', authorName: myInfo.name, authorAvatar: myInfo.avatar };
                appendMessage(message); // Pass activeCharacter for bubble styling
                activeCharacter.messages.push(message);
                saveCharactersToLocalStorage();
                messageInput.value = '';
                messageInput.focus();
            }

            function appendMessage(msg) {
                if (msg.type === 'text') {
                    // Pass bubbleSettings from activeCharacter for bubble styling
                    if (msg.sender === 'system') {
                        const messageRow = document.createElement('div');
                        messageRow.className = 'message-row system-message';
                        const systemText = document.createElement('span');
                        systemText.className = 'chat-system-text';
                        systemText.textContent = msg.content;
                        messageRow.appendChild(systemText);
                        dialogueContent.appendChild(messageRow);
                    } else {
                        appendBubble(msg.sender === 'me' ? 'my-bubble' : 'their-bubble', msg.content, msg.authorName, msg.authorAvatar, activeCharacter.bubbleSettings, msg.isTyping);
                    }
                } else if (msg.type === 'voice') {
                    // Pass bubbleSettings from activeCharacter to appendVoiceBubble
                    appendVoiceBubble(msg.sender === 'me', msg.content, msg.duration, msg.authorName, msg.authorAvatar, activeCharacter.bubbleSettings);
                }
                dialogueContent.scrollTop = dialogueContent.scrollHeight; // Ensure scrolling to bottom after any message
            }

            // Modified appendBubble to apply custom bubble styles and handle typing indicator
            function appendBubble(bubbleType, text, authorName = null, authorAvatar = null, bubbleSettings = {}, isTyping = false) {
                const messageRow = document.createElement('div');
                const bubble = document.createElement('div');
                const avatar = document.createElement('div');
                
                avatar.className = 'chat-avatar';
                bubble.className = `chat-bubble ${bubbleType}`;

                // Apply custom CSS if available
                if (bubbleSettings.customCss && bubbleSettings.customCss.trim() !== '') {
                    bubble.style.cssText = bubbleSettings.customCss.trim();
                } else {
                    // Apply custom colors if no custom CSS
                    if (bubbleType === 'my-bubble') {
                        const bgColor = bubbleSettings.myBubbleColor || '#007AFF';
                        bubble.style.backgroundColor = bgColor;
                        bubble.style.color = getContrastingTextColor(bgColor); // Auto-set text color for contrast
                        bubble.style.borderRadius = '18px 18px 4px 18px'; // Default iOS style
                        bubble.style.border = '1px solid rgba(0, 0, 0, 0.1)'; // My bubble border
                    } else { // their-bubble
                        const bgColor = bubbleSettings.theirBubbleColor || '#FFFFFF';
                        bubble.style.backgroundColor = bgColor;
                        bubble.style.color = getContrastingTextColor(bgColor); // Auto-set text color for contrast
                        bubble.style.border = '1px solid #E5E5EA'; // Keep border for their bubble default
                        bubble.style.borderRadius = '18px 18px 18px 4px'; // Default iOS style
                    }
                }

                if (isTyping) {
                    bubble.classList.add('typing-indicator');
                    bubble.innerHTML = `
                        <div class="dot-flashing">
                            <div class="dot"></div>
                            <div class="dot"></div>
                            <div class="dot"></div>
                        </div>
                    `;
                    messageRow.dataset.isTyping = true; // Mark row for easy removal
                } else {
                    bubble.textContent = text;
                }

                if (bubbleType === 'my-bubble') {
                    messageRow.className = 'message-row my-message';
                    if (myInfo.avatar) { avatar.style.backgroundImage = `url(${myInfo.avatar})`; }
                    messageRow.appendChild(bubble);
                    messageRow.appendChild(avatar);
                } else {
                    messageRow.className = 'message-row their-message';
                    if (authorAvatar) { avatar.style.backgroundImage = `url(${authorAvatar})`; }
                    messageRow.appendChild(avatar);
                    messageRow.appendChild(bubble);
                }
                dialogueContent.appendChild(messageRow);
                dialogueContent.scrollTop = dialogueContent.scrollHeight;
                return messageRow; // Return the created message row for typing indicator removal
            }

            // Modified appendVoiceBubble to apply custom bubble styles
            function appendVoiceBubble(isMyMessage, text, duration, authorName, authorAvatar, bubbleSettings = {}) {
                const messageRow = document.createElement('div');
                const bubble = document.createElement('div');
                const avatar = document.createElement('div');
                
                avatar.className = 'chat-avatar';
                bubble.className = 'wechat-voice-bubble';
                bubble.dataset.text = text;
                bubble.innerHTML = `<span class="voice-duration">${duration}</span><div class="wechat-voice-icon"><span class="bar1"></span><span class="bar2"></span><span class="bar3"></span></div>`;
                
                // Apply custom CSS if available
                if (bubbleSettings.customCss && bubbleSettings.customCss.trim() !== '') {
                    bubble.style.cssText = bubbleSettings.customCss.trim();
                    // Custom CSS might override color of voice icon/duration, might need specific targeting or user to include.
                } else {
                    // Apply custom colors if no custom CSS
                    if (isMyMessage) {
                        const bgColor = bubbleSettings.myBubbleColor || '#007AFF';
                        bubble.style.backgroundColor = bgColor;
                        bubble.style.color = getContrastingTextColor(bgColor);
                        // Update voice icon/duration color for contrast if needed
                        bubble.querySelectorAll('.wechat-voice-icon span, .voice-duration').forEach(el => el.style.backgroundColor = el.style.color = getContrastingTextColor(bgColor));
                        bubble.style.borderRadius = '18px 18px 4px 18px';
                        bubble.style.border = '1px solid rgba(0, 0, 0, 0.1)'; // My voice bubble border
                    } else { // their-bubble
                        const bgColor = bubbleSettings.theirBubbleColor || '#FFFFFF';
                        bubble.style.backgroundColor = bgColor;
                        bubble.style.color = getContrastingTextColor(bgColor);
                        bubble.style.border = '1px solid #E5E5EA';
                        bubble.querySelectorAll('.wechat-voice-icon span, .voice-duration').forEach(el => el.style.backgroundColor = el.style.color = getContrastingTextColor(bgColor));
                        bubble.style.borderRadius = '18px 18px 18px 4px';
                    }
                }


                if (isMyMessage) {
                    messageRow.className = 'message-row my-message';
                    if (myInfo.avatar) avatar.style.backgroundImage = `url(${myInfo.avatar})`;
                    messageRow.appendChild(bubble);
                    messageRow.appendChild(avatar);
                } else {
                    messageRow.className = 'message-row their-message';
                    if (authorAvatar) avatar.style.backgroundImage = `url(${authorAvatar})`;
                    messageRow.appendChild(avatar);
                    messageRow.appendChild(bubble);
                }
                dialogueContent.appendChild(messageRow);
                dialogueContent.scrollTop = dialogueContent.scrollHeight;
            }

            function saveCharactersToLocalStorage() { localStorage.setItem('savedCharacters', JSON.stringify(characters)); }
            function loadCharactersFromLocalStorage() { 
                const saved = localStorage.getItem('savedCharacters'); 
                if (saved) { 
                    characters = JSON.parse(saved); 
                    characters.forEach(char => { 
                        if (!char.isGroup) { 
                            char.age = char.age || null; 
                            char.birthday = char.birthday || null; 
                            char.localWorldBookId = char.localWorldBookId || 'none'; 
                            char.pinned = char.hasOwnProperty('pinned') ? char.pinned : false; // Initialize pinned property
                            // Initialize bubble settings if not present
                            char.bubbleSettings = char.bubbleSettings || { myBubbleColor: '#007AFF', theirBubbleColor: '#FFFFFF', customCss: '' };
                        } else {
                            // For groups, ensure bubble settings are also initialized if needed, or handle separately
                            char.localWorldBookId = char.localWorldBookId || 'none';
                            char.bubbleSettings = char.bubbleSettings || { myBubbleColor: '#007AFF', theirBubbleColor: '#FFFFFF', customCss: '' };
                        }
                    }); 
                } else { 
                    characters = []; 
                } 
            }
            
            // --- å¥½å‹è®¾å®š ---
            const friendLocalWorldSelect = document.getElementById('friend-local-world-select');
            // New bubble customization elements
            const myBubbleColorPicker = document.getElementById('my-bubble-color-picker');
            const theirBubbleColorPicker = document.getElementById('their-bubble-color-picker');
            const customBubbleCssInput = document.getElementById('custom-bubble-css');
            const previewMyBubble = document.getElementById('preview-my-bubble');
            const previewTheirBubble = document.getElementById('preview-their-bubble');
            const copyBubbleCssBtn = document.getElementById('copy-bubble-css-btn');
            const clearBubbleCssBtn = document.getElementById('clear-bubble-css-btn');
            const bubbleCssExampleContent = customBubbleCssInput.placeholder; // Use placeholder as example content


            document.getElementById('edit-friend-info-btn').addEventListener('click', () => { 
                if (!activeCharacter) return; 
                editingCharacterId = activeCharacter.id; 
                populateWorldBookSelects(); 
                charNameInput.value = activeCharacter.name; 
                charSettingInput.value = activeCharacter.setting; 
                charWorldSelect.value = activeCharacter.worldBookId || 'none'; 
                if (activeCharacter.avatar) { 
                    charAvatarPreview.style.backgroundImage = `url(${activeCharacter.avatar})`; 
                    charAvatarPreview.classList.add('has-image'); 
                    newCharAvatarDataUrl = activeCharacter.avatar; 
                } else { 
                    charAvatarPreview.style.backgroundImage = ''; 
                    charAvatarPreview.classList.remove('has-image'); 
                } 
                populateMyInfoForm(); 
                showScreen('characterSettings'); 
            });
            
            // --- ä¸ºâ€œä¸€é”®æ¸…é™¤å¯¹è¯â€æ·»åŠ ç¡®è®¤å¼¹çª—å’ŒæˆåŠŸæç¤ºå¼¹çª— ---
            document.getElementById('clear-dialogue-btn').onclick = function() { 
                if (!activeCharacter) return; 
                // å…ˆå¼¹å‡ºç¡®è®¤æ¡†
                showConfirmationModal(`ç¡®å®šè¦æ¸…é™¤ä¸ ${activeCharacter.name} çš„æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`, () => { 
                    // ç”¨æˆ·ç‚¹å‡»â€œç¡®è®¤â€åæ‰§è¡Œ
                    activeCharacter.messages = []; 
                    saveCharactersToLocalStorage(); 
                    dialogueContent.innerHTML = ''; 
                    // æ˜¾ç¤ºæ“ä½œæˆåŠŸçš„æç¤ºå¼¹çª— (æ— éœ€å›è°ƒï¼Œå› ä¸ºä¸æ¶‰åŠå±å¹•åˆ‡æ¢)
                    showFeedbackModal('èŠå¤©è®°å½•å·²æ¸…é™¤'); 
                }); 
            };

            function renderFriendSettings() { 
                if (!activeCharacter) return; 
                document.getElementById('friend-settings-character-name').textContent = `${activeCharacter.name} çš„è®¾ç½®`; 
                // Removed japanese-id-card and its associated elements and logic
                populateFriendLocalWorldBookSelect(); 

                // Populate bubble customization settings
                const bubbleSettings = activeCharacter.bubbleSettings || {};
                myBubbleColorPicker.value = bubbleSettings.myBubbleColor || '#007AFF';
                theirBubbleColorPicker.value = bubbleSettings.theirBubbleColor || '#FFFFFF';
                customBubbleCssInput.value = bubbleSettings.customCss || '';
                updateBubblePreviews();

                // Initialize copyBubbleCssBtn text based on customCss presence
                if (activeCharacter.bubbleSettings.customCss && activeCharacter.bubbleSettings.customCss.trim() !== '') {
                    copyBubbleCssBtn.textContent = 'ä¿å­˜æ°”æ³¡';
                } else {
                    copyBubbleCssBtn.textContent = 'åŠ è½½ç¤ºä¾‹CSS';
                }
            }

            function populateFriendLocalWorldBookSelect() { 
                friendLocalWorldSelect.innerHTML = '<option value="none">æ— </option>'; 
                worldBooks.local.forEach(book => { 
                    const option = document.createElement('option'); 
                    option.value = book.id; 
                    option.textContent = book.name; 
                    friendLocalWorldSelect.appendChild(option); 
                }); 
                if (activeCharacter) friendLocalWorldSelect.value = activeCharacter.localWorldBookId; 
            }

            // Bubble customization logic
            function updateBubblePreviews() {
                if (!activeCharacter) return; // Ensure activeCharacter is set before updating previews

                const bubbleSettings = activeCharacter.bubbleSettings || {};
                const myColor = myBubbleColorPicker.value;
                const theirColor = theirBubbleColorPicker.value;
                const customCss = customBubbleCssInput.value.trim();

                // Reset styles
                previewMyBubble.style.cssText = '';
                previewTheirBubble.style.cssText = '';

                if (customCss !== '') {
                    previewMyBubble.style.cssText = customCss;
                    previewTheirBubble.style.cssText = customCss;
                } else {
                    previewMyBubble.style.backgroundColor = myColor;
                    previewMyBubble.style.color = getContrastingTextColor(myColor);
                    previewMyBubble.style.borderRadius = '18px 18px 4px 18px'; // Default iOS style
                    previewMyBubble.style.border = '1px solid rgba(0, 0, 0, 0.1)'; // My bubble border in preview

                    previewTheirBubble.style.backgroundColor = theirColor;
                    previewTheirBubble.style.color = getContrastingTextColor(theirColor);
                    previewTheirBubble.style.border = '1px solid #E5E5EA'; // Default border
                    previewTheirBubble.style.borderRadius = '18px 18px 18px 4px'; // Default iOS style
                }
            }

            myBubbleColorPicker.addEventListener('input', () => {
                if (activeCharacter) {
                    activeCharacter.bubbleSettings.myBubbleColor = myBubbleColorPicker.value;
                    saveCharactersToLocalStorage();
                    updateBubblePreviews();
                }
            });

            theirBubbleColorPicker.addEventListener('input', () => {
                if (activeCharacter) {
                    activeCharacter.bubbleSettings.theirBubbleColor = theirBubbleColorPicker.value;
                    saveCharactersToLocalStorage();
                    updateBubblePreviews();
                }
            });

            customBubbleCssInput.addEventListener('input', () => {
                // Any change in the textarea will enable the 'ä¿å­˜æ°”æ³¡' state if it's currently 'åŠ è½½ç¤ºä¾‹CSS'
                if (activeCharacter) {
                    // Check if the current value is the example content exactly, if so, keep button as 'åŠ è½½ç¤ºä¾‹CSS'
                    if (customBubbleCssInput.value.trim() === bubbleCssExampleContent.trim() && copyBubbleCssBtn.textContent === 'åŠ è½½ç¤ºä¾‹CSS') {
                        // Do nothing, keep it as 'åŠ è½½ç¤ºä¾‹CSS'
                    } else if (copyBubbleCssBtn.textContent === 'åŠ è½½ç¤ºä¾‹CSS') {
                        copyBubbleCssBtn.textContent = 'ä¿å­˜æ°”æ³¡'; // If user starts typing, change button to Save
                    }
                    // No automatic save here, it will be saved on button click
                    // For live preview, call updateBubblePreviews
                    activeCharacter.bubbleSettings.customCss = customBubbleCssInput.value; // Temporarily update for live preview
                    updateBubblePreviews();
                }
            });

            copyBubbleCssBtn.addEventListener('click', () => {
                if (!activeCharacter) return;

                if (copyBubbleCssBtn.textContent === 'åŠ è½½ç¤ºä¾‹CSS') {
                    // Load example CSS into textarea and save it
                    customBubbleCssInput.value = bubbleCssExampleContent.trim();
                    activeCharacter.bubbleSettings.customCss = customBubbleCssInput.value;
                    saveCharactersToLocalStorage();
                    updateBubblePreviews();
                    showFeedbackModal('ç¤ºä¾‹CSSå·²åŠ è½½å¹¶ä¿å­˜ï¼');
                    copyBubbleCssBtn.textContent = 'ä¿å­˜æ°”æ³¡'; // Change button text
                } else { // Button text is 'ä¿å­˜æ°”æ³¡'
                    // Save current CSS from textarea
                    activeCharacter.bubbleSettings.customCss = customBubbleCssInput.value.trim();
                    saveCharactersToLocalStorage();
                    updateBubblePreviews();
                    showFeedbackModal('æ°”æ³¡è‡ªå®šä¹‰CSSå·²ä¿å­˜ï¼');
                }
            });

            clearBubbleCssBtn.addEventListener('click', () => {
                if (activeCharacter) {
                    showConfirmationModal('ç¡®å®šè¦æ¸…é™¤è‡ªå®šä¹‰æ°”æ³¡CSSå—ï¼Ÿè¿™å°†æ¢å¤é¢œè‰²é€‰æ‹©å™¨è®¾ç½®ã€‚', () => {
                        activeCharacter.bubbleSettings.customCss = '';
                        customBubbleCssInput.value = '';
                        saveCharactersToLocalStorage();
                        updateBubblePreviews();
                        showFeedbackModal('è‡ªå®šä¹‰CSSå·²æ¸…é™¤ã€‚');
                        copyBubbleCssBtn.textContent = 'åŠ è½½ç¤ºä¾‹CSS'; // Reset button text after clearing
                    });
                }
            });


            // --- API è®¾ç½® & AI å›å¤ ---
            const apiUrlInput = document.getElementById('api-url-input'); const apiKeyInput = document.getElementById('api-key-input'); const modelSelect = document.getElementById('model-select'); const fetchModelsBtn = document.getElementById('fetch-models-btn'); 
            function saveApiSettings() { 
                const settings = { url: apiUrlInput.value.trim(), key: apiKeyInput.value.trim(), model: modelSelect.value }; 
                localStorage.setItem('apiSettings', JSON.stringify(settings)); 
                showFeedbackModal('API è®¾ç½®å·²ä¿å­˜ï¼'); 
            } 
            function loadApiSettings() { 
                const saved = localStorage.getItem('apiSettings'); 
                if (saved) { 
                    const settings = JSON.parse(saved); 
                    apiUrlInput.value = settings.url || ''; 
                    apiKeyInput.value = settings.key || ''; 
                    if(settings.model) { 
                        modelSelect.innerHTML = `<option value="${settings.model}">${settings.model}</option>`; 
                        modelSelect.value = settings.model; 
                    } 
                } 
            } 
            document.getElementById('api-save-btn').addEventListener('click', saveApiSettings); 
            fetchModelsBtn.addEventListener('click', async () => { /* ... API fetch logic ... */ }); 
            
            // AI Reply Functionality
            document.getElementById('ai-reply-btn').addEventListener('click', generateAIReply);

            async function generateAIReply() {
                if (!activeCharacter) {
                    showFeedbackModal('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¥½å‹å¼€å§‹å¯¹è¯ã€‚', false);
                    return;
                }

                const apiSettings = JSON.parse(localStorage.getItem('apiSettings') || '{}');
                if (!apiSettings.url || !apiSettings.key || !apiSettings.model) {
                    showFeedbackModal('APIæœªé…ç½®ï¼Œè¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®APIåœ°å€ã€å¯†é’¥å’Œæ¨¡å‹ã€‚', false);
                    return;
                }

                const typingIndicatorRow = appendBubble('their-bubble', 'å¯¹æ–¹æ­£åœ¨è¾“å…¥ä¸­...', activeCharacter.name, activeCharacter.avatar, activeCharacter.bubbleSettings, true);
                
                // Scroll to bottom immediately after adding typing indicator
                setTimeout(() => dialogueContent.scrollTop = dialogueContent.scrollHeight, 0);


                try {
                    const messagesForAI = [
                        { role: "system", content: `ä½ æ˜¯ä¸€ä¸ªåä¸º ${activeCharacter.name} çš„è§’è‰²ã€‚${activeCharacter.setting}\næˆ‘çš„åå­—æ˜¯ ${myInfo.name}ï¼Œæˆ‘çš„è®¾å®šæ˜¯ ${myInfo.setting}ã€‚` }
                    ];

                    // Add world book context
                    let worldBookContent = '';
                    if (activeCharacter.worldBookId && activeCharacter.worldBookId !== 'none') {
                        const globalBook = worldBooks.global.find(b => b.id == activeCharacter.worldBookId);
                        if (globalBook) worldBookContent += `\nå…¨å±€ä¸–ç•Œä¹¦ï¼š${globalBook.name}\nå†…å®¹ï¼š${globalBook.content}`;
                    }
                    if (activeCharacter.localWorldBookId && activeCharacter.localWorldBookId !== 'none') {
                        const localBook = worldBooks.local.find(b => b.id == activeCharacter.localWorldBookId);
                        if (localBook) worldBookContent += `\nå±€éƒ¨ä¸–ç•Œä¹¦ï¼š${localBook.name}\nå†…å®¹ï¼š${localBook.content}`;
                    }
                    if (worldBookContent) {
                        messagesForAI[0].content += `\nä»¥ä¸‹æ˜¯ä¸–ç•Œè§‚ä¿¡æ¯ï¼Œè¯·åœ¨å›å¤ä¸­èå…¥ï¼š\n${worldBookContent}`;
                    }

                    // Add recent chat history (last 5-10 messages)
                    const recentMessages = activeCharacter.messages.slice(-10); // Get last 10 messages
                    recentMessages.forEach(msg => {
                        // Only add 'me' or 'assistant' messages to AI context, skip system messages
                        if (msg.sender === 'me' || msg.sender === 'their') {
                            messagesForAI.push({
                                role: msg.sender === 'me' ? 'user' : 'assistant',
                                content: msg.content
                            });
                        }
                    });

                    // console.log("Sending to AI:", JSON.stringify(messagesForAI, null, 2)); // Debugging

                    const response = await fetch(apiSettings.url + '/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiSettings.key}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: apiSettings.model,
                            messages: messagesForAI,
                            max_tokens: 200,
                            temperature: 0.7
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`APIé”™è¯¯: ${response.status} - ${errorData.error ? errorData.error.message : response.statusText}`);
                    }

                    const data = await response.json();
                    const aiReply = data.choices[0].message.content.trim();

                    // Remove typing indicator
                    if (typingIndicatorRow && typingIndicatorRow.parentNode) {
                        typingIndicatorRow.parentNode.removeChild(typingIndicatorRow);
                    }

                    // Append AI's reply
                    const aiMessage = { type: 'text', content: aiReply, sender: 'their', authorName: activeCharacter.name, authorAvatar: activeCharacter.avatar };
                    appendMessage(aiMessage);
                    activeCharacter.messages.push(aiMessage);
                    saveCharactersToLocalStorage();

                } catch (error) {
                    if (typingIndicatorRow && typingIndicatorRow.parentNode) {
                        typingIndicatorRow.parentNode.removeChild(typingIndicatorRow);
                    }
                    console.error("AIå›å¤è¯·æ±‚å¤±è´¥:", error);
                    showFeedbackModal(`AIå›å¤å¤±è´¥: ${error.message} (è¯·æ£€æŸ¥APIè®¾ç½®æˆ–ç½‘ç»œ)`, false);
                }
            }


            // --- ä¸–ç•Œä¹¦åŠŸèƒ½ ---
            const worldBookModalOverlay = document.getElementById('worldBookModalOverlay'); const worldBookModalTitle = document.getElementById('world-book-modal-title'); const worldBookNameInput = document.getElementById('world-book-name-input'); const worldBookContentInput = document.getElementById('world-book-content-input'); const createWorldBookBtn = document.getElementById('create-world-book-btn'); let worldBooks = { global: [], local: [] }; let editingWorldBook = { type: null, id: null };
            function loadWorldBooks() { const saved = localStorage.getItem('worldBooks'); if (saved) { worldBooks = JSON.parse(saved); } else { worldBooks = { global: [], local: [] }; } } function saveWorldBooks() { localStorage.setItem('worldBooks', JSON.stringify(worldBooks)); }
            function renderWorldBooks() { const globalList = document.getElementById('global-world-books-list'); const localList = document.getElementById('local-world-books-list'); globalList.innerHTML = ''; localList.innerHTML = ''; const createItemHTML = (book, type) => `<span>${book.name}</span><div><button class="edit-btn" data-type="${type}" data-id="${book.id}">ç¼–è¾‘</button><button class="delete-btn" data-type="${type}" data-id="${book.id}">åˆ é™¤</button></div>`; worldBooks.global.forEach(book => { const item = document.createElement('div'); item.className = 'world-book-item'; item.innerHTML = createItemHTML(book, 'global'); globalList.appendChild(item); }); worldBooks.local.forEach(book => { const item = document.createElement('div'); item.className = 'world-book-item'; item.innerHTML = createItemHTML(book, 'local'); localList.appendChild(item); }); }
            document.querySelector('.world-book-main').addEventListener('click', e => { if (e.target.classList.contains('edit-btn')) { const { type, id } = e.target.dataset; const book = worldBooks[type].find(b => b.id == id); if (book) { editingWorldBook = { type, id }; worldBookModalTitle.textContent = 'ç¼–è¾‘ä¸–ç•Œä¹¦'; worldBookNameInput.value = book.name; worldBookContentInput.value = book.content; worldBookModalOverlay.style.display = 'flex'; } } else if (e.target.classList.contains('delete-btn')) { const { type, id } = e.target.dataset; showConfirmationModal('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¸–ç•Œä¹¦å—ï¼Ÿ', () => { worldBooks[type] = worldBooks[type].filter(b => b.id != id); saveWorldBooks(); renderWorldBooks(); showFeedbackModal('åˆ é™¤æˆåŠŸ'); }); } });
            createWorldBookBtn.addEventListener('click', () => { editingWorldBook = { type: createWorldBookBtn.dataset.type, id: null }; worldBookModalTitle.textContent = `åˆ›å»º${createWorldBookBtn.dataset.type === 'global' ? 'å…¨å±€' : 'å±€éƒ¨'}ä¸–ç•Œä¹¦`; worldBookNameInput.value = ''; worldBookContentInput.value = ''; worldBookModalOverlay.style.display = 'flex'; });
            document.getElementById('world-book-save-btn').addEventListener('click', () => { const name = worldBookNameInput.value.trim(); const content = worldBookContentInput.value.trim(); if (!name || !content) { showFeedbackModal('åç§°å’Œå†…å®¹ä¸èƒ½ä¸ºç©ºï¼', false); return; } const { type, id } = editingWorldBook; if (id) { const book = worldBooks[type].find(b => b.id == id); if(book) { book.name = name; book.content = content; } } else { worldBooks[type].push({ id: Date.now(), name, content }); } saveWorldBooks(); renderWorldBooks(); worldBookModalOverlay.style.display = 'none'; showFeedbackModal('ä¿å­˜æˆåŠŸ'); }); // Added renderWorldBooks call
            document.getElementById('world-book-cancel-btn').addEventListener('click', () => worldBookModalOverlay.style.display = 'none');
            document.querySelectorAll('.world-book-tabs .tab-button').forEach(btn => { btn.addEventListener('click', () => { document.querySelector('.world-book-tabs .tab-button.active').classList.remove('active'); btn.classList.add('active'); document.querySelector('.world-book-tab-content.active').classList.remove('active'); document.getElementById(`${btn.dataset.type}-world-books-content`).classList.add('active'); createWorldBookBtn.textContent = `åˆ›å»º${btn.dataset.type === 'global' ? 'å…¨å±€' : 'å±€éƒ¨'}ä¸–ç•Œä¹¦`; createWorldBookBtn.dataset.type = btn.dataset.type; }); });
            function populateWorldBookSelects() { charWorldSelect.innerHTML = '<option value="none">æ— </option>'; worldBooks.global.forEach(book => { const option = document.createElement('option'); option.value = book.id; option.textContent = book.name; charWorldSelect.appendChild(option); }); }

            // ====================================================
            // ============ å¾®ä¿¡ App é€»è¾‘ =======================
            // ====================================================
            const wechatHeaderTitle = document.getElementById('wechat-header-title'); const wechatHeaderActions = document.getElementById('wechat-header-actions'); const wechatBackBtn = document.getElementById('wechat-back-to-home-btn'); const wechatNavItems = document.querySelectorAll('.wechat-nav-item'); const wechatPages = document.querySelectorAll('.wechat-page'); const momentsPostsContainer = document.getElementById('moments-posts-container'); let currentWechatPage = 'chat-list'; let hasSimulatedThisSession = false; let wechatData = { moments: { name: 'è‡ªå®šä¹‰åå­—', avatar: null, bg: null, posts: [] }, me: { name: 'è‡ªå®šä¹‰åå­—', avatar: null, id: 'your_id_here' } }; let currentMomentData = {};
            function saveWechatDataToLocalStorage() { localStorage.setItem('wechatData', JSON.stringify(wechatData)); }
            function loadWechatDataFromLocalStorage() { const saved = localStorage.getItem('wechatData'); if (saved) wechatData = JSON.parse(saved); if (!wechatData.moments.posts) wechatData.moments.posts = []; }
            function updateAllWechatNames(name) { wechatData.moments.name = name; wechatData.me.name = name; saveWechatDataToLocalStorage(); }
            document.getElementById('wechat-app-btn').addEventListener('click', () => { showScreen('wechatContainer'); renderWechatPage('chat-list'); });
            wechatBackBtn.addEventListener('click', () => showScreen('phone'));
            wechatNavItems.forEach(item => { item.addEventListener('click', () => renderWechatPage(item.dataset.page)); });
            async function renderWechatPage(pageName) { currentWechatPage = pageName; wechatNavItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageName)); wechatPages.forEach(page => page.classList.toggle('active', page.id === `wechat-${pageName}-page`)); wechatHeaderActions.innerHTML = ''; wechatBackBtn.style.display = 'none'; switch(pageName) { case 'chat-list': wechatBackBtn.style.display = 'block'; wechatHeaderTitle.textContent = 'å¾®ä¿¡'; const addFriendBtn = document.createElement('button'); addFriendBtn.textContent = 'ğŸ‘¤+'; addFriendBtn.title = 'æ·»åŠ å¥½å‹ (è§’è‰²è®¾å®š)'; addFriendBtn.onclick = () => { editingCharacterId = null; resetCharacterForm(); populateMyInfoForm(); populateWorldBookSelects(); showScreen('characterSettings'); }; wechatHeaderActions.appendChild(addFriendBtn); renderCharacterList(characterListContainer); break; case 'contacts': wechatHeaderTitle.textContent = 'é€šè®¯å½•'; const createGroupBtn = document.createElement('button'); createGroupBtn.textContent = 'âœš'; createGroupBtn.title = "åˆ›å»ºç¾¤èŠ"; createGroupBtn.onclick = () => showSelectFriendsScreen('group-chat'); wechatHeaderActions.appendChild(createGroupBtn); renderContactsList(); break; case 'moments': wechatHeaderTitle.textContent = 'æœ‹å‹åœˆ'; const cameraBtn = document.createElement('button'); cameraBtn.textContent = 'ğŸ“·'; cameraBtn.onclick = () => { resetMomentData(); showScreen('wechatNewMoment'); }; wechatHeaderActions.appendChild(cameraBtn); renderMomentsList(); if (!hasSimulatedThisSession) { simulateAIInteraction(); hasSimulatedThisSession = true; } break; case 'me': wechatHeaderTitle.textContent = 'æˆ‘'; document.getElementById('me-avatar-editable').style.backgroundImage = wechatData.me.avatar ? `url(${wechatData.me.avatar})` : 'none'; document.getElementById('me-name-editable').textContent = wechatData.me.name; document.getElementById('me-id-editable').textContent = wechatData.me.id; break; } }
            function renderContactsList() {  const container = document.getElementById('wechat-contacts-list'); const nonGroupCharacters = characters.filter(c => !c.isGroup); container.innerHTML = ''; if (nonGroupCharacters.length === 0) { container.innerHTML = '<p style="text-align:center; color:#8A8FA0; margin-top: 40px;">è¿˜æ²¡æœ‰å¥½å‹</p>'; return; } nonGroupCharacters.forEach(char => { const item = document.createElement('div'); item.className = 'character-item'; item.innerHTML = `<div class="character-avatar" style="background-image: url(${char.avatar || ''}); border-radius: 8px;"></div><span class="character-name">${char.name}</span>`; item.addEventListener('click', () => openDialogue(char.id)); container.appendChild(item); }); }
            document.getElementById('me-wallet-btn').addEventListener('click', () => showScreen('wechatWallet')); document.getElementById('wechat-wallet-back-btn').addEventListener('click', () => showScreen('wechatContainer'));
            const momentTextarea = document.getElementById('new-moment-textarea'); const momentLocationValue = document.getElementById('moment-location-value'); const momentVisibilityValue = document.getElementById('moment-visibility-value');
            function resetMomentData() { currentMomentData = { text: '', location: '', visibility: { type: 'public', list: [] } }; momentTextarea.value = ''; momentLocationValue.textContent = 'ä¸æ˜¾ç¤ºä½ç½®'; momentVisibilityValue.textContent = 'å…¬å¼€'; document.getElementById('visibility-public').checked = true; }
            document.getElementById('wechat-cancel-moment-btn').addEventListener('click', () => showScreen('wechatContainer'));
            document.getElementById('wechat-post-moment-btn').addEventListener('click', () => { const newPost = { id: Date.now(), authorId: 'user', authorName: wechatData.me.name, authorAvatar: wechatData.me.avatar, text: momentTextarea.value.trim(), location: currentMomentData.location, timestamp: new Date().toISOString(), comments: [], visibility: currentMomentData.visibility }; wechatData.moments.posts.unshift(newPost); saveWechatDataToLocalStorage(); showFeedbackModal('å‘å¸ƒæˆåŠŸ'); showScreen('wechatContainer'); renderWechatPage('moments'); });
            document.getElementById('moment-location-btn').addEventListener('click', () => { openTextEditor(momentLocationValue, "æ‰€åœ¨ä½ç½®", (newValue) => { currentMomentData.location = newValue; momentLocationValue.textContent = newValue || 'ä¸æ˜¾ç¤ºä½ç½®'; }); });
            document.getElementById('moment-visibility-btn').addEventListener('click', () => showScreen('wechatVisibilitySettings'));
            document.getElementById('wechat-visibility-back-btn').addEventListener('click', () => showScreen('wechatNewMoment'));
            document.getElementById('visibility-public').addEventListener('click', () => { currentMomentData.visibility = { type: 'public', list: [] }; momentVisibilityValue.textContent = 'å…¬å¼€'; showScreen('wechatNewMoment'); });
            document.getElementById('visibility-show-some').addEventListener('click', () => showSelectFriendsScreen('moment-show-some'));
            document.getElementById('visibility-hide-some').addEventListener('click', () => showSelectFriendsScreen('moment-hide-some'));
            function renderMomentsList() { document.getElementById('moments-bg-editable').style.backgroundImage = wechatData.moments.bg ? `url(${wechatData.moments.bg})` : 'none'; document.getElementById('moments-avatar-editable').style.backgroundImage = wechatData.moments.avatar ? `url(${wechatData.moments.avatar})` : 'none'; document.getElementById('moments-user-name-editable').textContent = wechatData.moments.name; momentsPostsContainer.innerHTML = ''; if (wechatData.moments.posts.length === 0) { momentsPostsContainer.innerHTML = '<p style="text-align:center; color:#888; padding:20px;">è¿˜æ²¡æœ‰åŠ¨æ€ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§</p>'; return; } wechatData.moments.posts.forEach(post => { const postEl = document.createElement('div'); postEl.className = 'moment-post'; const commentsHTML = post.comments.map(c => `<div class="moment-comment" id="comment-${c.id}"><span class="comment-author">${c.authorName}: </span><span>${c.text}</span></div>`).join(''); postEl.innerHTML = `<div class="moment-post-avatar" style="background-image: url(${post.authorAvatar || ''}); background-size: cover; background-position: center;"></div><div class="moment-post-main"><div class="moment-post-author">${post.authorName}</div><div class="moment-post-content">${post.text}</div>${post.location ? `<div class="moment-post-location">${post.location}</div>` : ''}<div class="moment-post-footer"><span>${new Date(post.timestamp).toLocaleString()}</span>${post.authorId === 'user' ? `<span class="moment-delete-btn" data-post-id="${post.id}">åˆ é™¤</span>` : ''}</div>${commentsHTML ? `<div class="moment-comments-section">${commentsHTML}</div>` : ''}</div>`; momentsPostsContainer.appendChild(postEl); }); momentsPostsContainer.querySelectorAll('.moment-delete-btn').forEach(btn => { btn.addEventListener('click', (e) => { const postId = e.target.dataset.postId; showConfirmationModal('ç¡®å®šè¦åˆ é™¤è¿™æ¡æœ‹å‹åœˆå—ï¼Ÿ', () => deleteMoment(postId)); }); }); }
            function deleteMoment(postId) { wechatData.moments.posts = wechatData.moments.posts.filter(p => p.id != postId); saveWechatDataToLocalStorage(); renderMomentsList(); }
            async function simulateAIInteraction() { /* ... AI simulation logic ... */ }
            let currentSelectFriendPurpose = '';
            function showSelectFriendsScreen(purpose, options = {}) { currentSelectFriendPurpose = purpose; const titleMap = { 'group-chat': 'é€‰æ‹©è”ç³»äºº', 'moment-show-some': 'é€‰æ‹©è°å¯ä»¥çœ‹', 'moment-hide-some': 'é€‰æ‹©ä¸ç»™è°çœ‹', 'group-admin': 'é€‰æ‹©ç®¡ç†å‘˜' }; document.getElementById('select-friends-title').textContent = titleMap[purpose] || 'é€‰æ‹©å¥½å‹'; const listEl = document.getElementById('wechat-select-friends-list'); listEl.innerHTML = ''; const friendSource = options.members ? options.members : characters.filter(c => !c.isGroup); friendSource.forEach(char => { const item = document.createElement('div'); item.className = 'friend-select-item'; item.innerHTML = `<input type="checkbox" id="friend-select-${char.id}" data-id="${char.id}"><label for="friend-select-${char.id}" style="display: flex; align-items: center; width: 100%;"><div class="character-avatar" style="width: 40px; height: 40px; border-radius: 6px; background-image: url(${char.avatar || ''})"></div><span class="character-name" style="margin-left: 10px;">${char.name}</span></label>`; listEl.appendChild(item); }); showScreen('wechatSelectFriends'); }
            document.getElementById('wechat-cancel-select-friends-btn').addEventListener('click', () => { if (currentSelectFriendPurpose.startsWith('moment')) { showScreen('wechatVisibilitySettings'); } else if (currentSelectFriendPurpose === 'group-admin') { showScreen('wechatGroupSettings'); } else { showScreen('wechatContainer'); } }); 
            
            // --- ä¸ºâ€œåˆ›å»ºç¾¤èŠâ€æ·»åŠ æˆåŠŸåçš„ç»¿è‰²å¼¹çª—ï¼Œå¹¶è°ƒæ•´å±å¹•åˆ‡æ¢å»¶è¿Ÿ ---
            document.getElementById('wechat-confirm-select-friends-btn').addEventListener('click', async () => { 
                const selectedIds = Array.from(document.getElementById('wechat-select-friends-list').querySelectorAll('input:checked')).map(input => parseInt(input.dataset.id)); 
                if (currentSelectFriendPurpose === 'group-chat') { 
                    if (selectedIds.length < 2) { showFeedbackModal('è¯·è‡³å°‘é€‰æ‹©2ä½å¥½å‹', false); return; } 
                    const members = characters.filter(c => selectedIds.includes(c.id)); 
                    let groupName = members.slice(0, 3).map(m => m.name).join(', '); 
                    if (members.length > 3) groupName += '...'; 
                    const groupAvatar = await createGroupAvatar(selectedIds); 
                    const newGroup = { 
                        id: Date.now(), 
                        name: groupName, 
                        avatar: groupAvatar, 
                        isGroup: true, 
                        members: selectedIds, 
                        messages: [], 
                        adminId: null, 
                        localWorldBookId: 'none',
                        bubbleSettings: { // Initialize bubble settings for new group
                            myBubbleColor: '#007AFF',
                            theirBubbleColor: '#FFFFFF',
                            customCss: ''
                        }
                    }; 
                    characters.unshift(newGroup); 
                    saveCharactersToLocalStorage(); 
                    
                    // NEW: Hide the current selection screen BEFORE showing the feedback modal
                    screens.wechatSelectFriends.style.display = 'none';

                    // Use callback for screen transition
                    showFeedbackModal('ç¾¤èŠåˆ›å»ºæˆåŠŸ', true, () => openDialogue(newGroup.id));
                } else if (currentSelectFriendPurpose === 'moment-show-some') { 
                    currentMomentData.visibility = { type: 'show-some', list: selectedIds }; 
                    momentVisibilityValue.textContent = `éƒ¨åˆ†å¯è§ (${selectedIds.length}äºº)`; 
                    showScreen('wechatNewMoment'); 
                } else if (currentSelectFriendPurpose === 'moment-hide-some') { 
                    currentMomentData.visibility = { type: 'hide-some', list: selectedIds }; 
                    momentVisibilityValue.textContent = `ä¸ç»™è°çœ‹ (${selectedIds.length}äºº)`; 
                    showScreen('wechatNewMoment'); 
                } else if (currentSelectFriendPurpose === 'group-admin' && activeCharacter) { 
                    activeCharacter.adminId = selectedIds[0] || null; 
                    saveCharactersToLocalStorage(); 
                    renderGroupSettings(); 
                    
                    // NEW: Hide the current selection screen BEFORE showing the feedback modal
                    screens.wechatSelectFriends.style.display = 'none';

                    // ä¿®æ”¹ï¼šä¸å†å‘é€ç³»ç»Ÿæ¶ˆæ¯åˆ°èŠå¤©ï¼Œè€Œæ˜¯å¼¹å‡ºæç¤ºâ€œè®¾ç½®æˆåŠŸâ€ï¼Œå¹¶ä½¿ç”¨å›è°ƒ
                    showFeedbackModal('è®¾ç½®æˆåŠŸ', true, () => showScreen('wechatGroupSettings'));
                } 
            });

            async function createGroupAvatar(memberIds) {
                // è¿™ä¸ªå‡½æ•°ç”¨äºåˆæˆç¾¤å¤´åƒï¼Œä¿æŒä¸å˜
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const size = 100; // å¤´åƒå¤§å°
                canvas.width = size;
                canvas.height = size;
                ctx.fillStyle = '#E5E5EA'; // é»˜è®¤èƒŒæ™¯è‰²
                ctx.fillRect(0, 0, size, size);

                const images = [];
                const members = characters.filter(c => memberIds.includes(c.id)).slice(0, 9); // æœ€å¤šå–9ä¸ª
                for (const member of members) {
                    if (member.avatar) {
                        try {
                            const img = await new Promise((resolve, reject) => {
                                const image = new Image();
                                image.crossOrigin = 'Anonymous';
                                image.onload = () => resolve(image);
                                image.onerror = () => resolve(null); // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œåˆ™è·³è¿‡
                                image.src = member.avatar;
                            });
                            if (img) images.push(img);
                        } catch (e) {
                            console.error("åŠ è½½å¤´åƒå¤±è´¥:", e);
                        }
                    }
                }

                if (images.length === 0) return null; // å¦‚æœæ²¡æœ‰æœ‰æ•ˆå¤´åƒï¼Œè¿”å›ç©º

                const gap = 3; // å›¾åƒä¹‹é—´çš„é—´éš™
                const numImages = images.length;
                let positions = [];

                if (numImages === 1) {
                    positions = [{ x: 0, y: 0, w: size, h: size }];
                } else if (numImages === 2) {
                    const w = (size - gap) / 2;
                    positions = [{ x: 0, y: 0, w: w, h: size }, { x: w + gap, y: 0, w: w, h: size }];
                } else if (numImages === 3) {
                    const w = (size - gap) / 2;
                    const h = (size - gap) / 2;
                    positions = [ { x: (size-w)/2, y: 0, w: w, h: h }, { x: 0, y: h + gap, w: w, h: h }, { x: w + gap, y: h + gap, w: w, h: h } ];
                } else if (numImages === 4) {
                    const w = (size - gap) / 2;
                    const h = (size - gap) / 2;
                    positions = [ { x: 0, y: 0, w: w, h: h }, { x: w + gap, y: 0, w: w, h: h }, { x: 0, y: h + gap, w: w, h: h }, { x: w + gap, y: h + gap, w: w, h: h }];
                } else { // 5-9ä¸ªéƒ½ç”¨ä¹å®«æ ¼
                    const w = (size - gap * 2) / 3;
                    const h = (size - gap * 2) / 3;
                    let coords;
                    if (numImages <= 9) { // é‡æ–°è®¡ç®—å±…ä¸­
                        const rows = Math.ceil(numImages / 3);
                        const startY = (size - (rows * h + (rows-1)*gap))/2;
                        let currentY = startY;
                        for(let i=0; i<rows; i++){
                            const colsInRow = (i === rows-1) ? (numImages - i*3) : 3;
                            const startX = (size - (colsInRow * w + (colsInRow-1)*gap))/2;
                            let currentX = startX;
                            for(let j=0; j<colsInRow; j++){
                                positions.push({x: currentX, y: currentY, w: w, h: h});
                                currentX += w + gap;
                            }
                            currentY += h + gap;
                        }
                    }
                }
                
                images.forEach((img, i) => {
                    const pos = positions[i];
                    if (pos) {
                        ctx.drawImage(img, pos.x, pos.y, pos.w, pos.h);
                    }
                });

                return canvas.toDataURL();
            }
            const groupSettingsNameValue = document.getElementById('group-settings-name-value'); const groupSettingsAvatarPreview = document.getElementById('group-settings-avatar-preview'); const groupSettingsAdminValue = document.getElementById('group-settings-admin-value'); const groupLocalWorldSelect = document.getElementById('group-local-world-select');
            document.getElementById('group-settings-back-btn').addEventListener('click', () => showScreen('dialogue')); function renderGroupSettings() { if (!activeCharacter || !activeCharacter.isGroup) return; groupSettingsNameValue.textContent = activeCharacter.name; groupSettingsAvatarPreview.style.backgroundImage = `url(${activeCharacter.avatar})`; const admin = characters.find(c => c.id === activeCharacter.adminId); groupSettingsAdminValue.textContent = admin ? admin.name : 'æœªè®¾ç½®'; groupLocalWorldSelect.innerHTML = '<option value="none">æ— </option>'; worldBooks.local.forEach(book => { const option = document.createElement('option'); option.value = book.id; option.textContent = book.name; groupLocalWorldSelect.appendChild(option); }); groupLocalWorldSelect.value = activeCharacter.localWorldBookId || 'none'; }
            document.getElementById('group-settings-name').addEventListener('click', () => { openTextEditor(groupSettingsNameValue, "ä¿®æ”¹ç¾¤èŠåç§°", (newName) => { activeCharacter.name = newName; saveCharactersToLocalStorage(); renderGroupSettings(); dialogueCharacterName.textContent = newName; }); }); document.getElementById('group-settings-avatar').addEventListener('click', () => setupImageEditor('element', groupSettingsAvatarPreview, null, 'group-avatar')); document.getElementById('group-settings-admin').addEventListener('click', () => { const members = characters.filter(c => activeCharacter.members.includes(c.id)); showSelectFriendsScreen('group-admin', { members }); }); groupLocalWorldSelect.addEventListener('change', (e) => { if(activeCharacter) { activeCharacter.localWorldBookId = e.target.value; saveCharactersToLocalStorage(); showFeedbackModal('å·²åº”ç”¨å±€éƒ¨ä¸–ç•Œä¹¦'); }});

            // --- è¯­éŸ³æ¶ˆæ¯åŠŸèƒ½ ---
            const functionsMenu = document.getElementById('functions-menu');
            document.getElementById('functions-toggle-btn').addEventListener('click', () => { functionsMenu.style.display = functionsMenu.style.display === 'flex' ? 'none' : 'flex'; });
            const voiceTextModalOverlay = document.getElementById('voiceTextModalOverlay'); const voiceTextContent = document.getElementById('voice-text-content'); document.getElementById('voice-text-close-btn').addEventListener('click', () => voiceTextModalOverlay.style.display = 'none');
            document.getElementById('menu-voice-btn').addEventListener('click', () => { functionsMenu.style.display = 'none'; openTextEditor(null, "ç¼–è¾‘è¯­éŸ³å†…å®¹", (text) => { if (!text) return; const duration = Math.max(1, Math.min(60, Math.floor(text.length / 4))); const message = { type: 'voice', content: text, duration: `${duration}"`, sender: 'me', authorName: myInfo.name, authorAvatar: myInfo.avatar }; appendMessage(message); if (activeCharacter) { activeCharacter.messages.push(message); saveCharactersToLocalStorage(); } }); });
            
            dialogueContent.addEventListener('click', (e) => { const bubble = e.target.closest('.wechat-voice-bubble'); if (bubble && bubble.dataset.text) { voiceTextContent.textContent = bubble.dataset.text; voiceTextModalOverlay.style.display = 'flex'; } });

            // --- é¡µé¢åŠ è½½ ---
            function loadSavedSettings() {
                // åŠ è½½ä¸»é¢˜ã€ç”µæ± ã€å­—ä½“è®¾ç½®
                const savedTheme = localStorage.getItem('savedTheme'); if (savedTheme) { const s = JSON.parse(savedTheme); themeColorPicker.value = s.color; themeOpacitySlider.value = s.opacity; applyThemeColor(s.color); applyGlobalOpacity(s.opacity); }
                const savedBattery = localStorage.getItem('savedBatteryTheme'); if (savedBattery) { const s = JSON.parse(savedBattery); batteryFillColorPicker.value = s.fillColor; batteryFillOpacitySlider.value = s.fillOpacity; batteryBorderColorPicker.value = s.borderColor; batteryBorderOpacitySlider.value = s.borderOpacity; applyBatteryStyle(s.fillColor, s.fillOpacity, '--battery-fill-color'); applyBatteryStyle(s.borderColor, s.borderOpacity, '--battery-border-color'); }
                const savedFont = localStorage.getItem('savedFontSettings'); if (savedFont) { const s = JSON.parse(savedFont); fontColorPicker.value = s.color; fontWeightSlider.value = s.weight; if (s.source === 'file' && s.value) { applyFont(s.source, s.value, s.color, s.weight); } else if (s.source === 'url' && s.value) { fontUrlInput.value = s.value; applyFont(s.source, s.value, s.color, s.weight); } else { applyFont(null, null, s.color, s.weight); } }
                const savedMyInfo = localStorage.getItem('myInfo'); if (savedMyInfo) myInfo = JSON.parse(savedMyInfo);
                document.querySelectorAll('.user-name.editable').forEach(el => el.textContent = myInfo.name);
            }
            
            // --- åˆå§‹åŒ– ---
            loadSavedSettings();
            loadWorldBooks();
            loadCharactersFromLocalStorage();
            loadApiSettings();
            loadWechatDataFromLocalStorage();
            showScreen('phone');

        });
    </script>

</body>
</html>